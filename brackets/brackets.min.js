const CLIENT_ID="qn0wimnszbqlwfnszdz3wwfz430eqr";let elements={loginExpiredModal:document.getElementById("loginExpiredModal"),loginExpiredRenew:document.getElementById("loginExpiredRenew"),loginExpiredReset:document.getElementById("loginExpiredReset"),deleteBracketModal:document.getElementById("deleteBracketModal"),deleteBracketModalBody:document.getElementById("deleteBracketModalBody"),deleteBracketButton:document.getElementById("deleteBracketButton"),quitBracketModal:document.getElementById("quitBracketModal"),previewModal:document.getElementById("previewModal"),previewModalBody:document.getElementById("previewModalBody"),importModal:document.getElementById("importModal"),importBracketType:document.getElementById("importBracketType"),importBracketLabel:document.getElementById("importBracketLabel"),importBracketValue:document.getElementById("importBracketValue"),importPreview:document.getElementById("importPreview"),browseModal:document.getElementById("browseModal"),browseModalBody:document.getElementById("browseModalBody"),startModal:document.getElementById("startModal"),optionLimit:document.getElementById("optionLimit"),changeCommand:document.getElementById("changeCommand"),keepVotingEnabled:document.getElementById("keepVotingEnabled"),disableAnimations:document.getElementById("disableAnimations"),vtsLink:document.getElementById("vtsLink"),status:document.getElementById("status"),topRight:document.getElementById("topRight"),loginButton:document.getElementById("loginButton"),channelName:document.getElementById("channelName"),connectbtn:document.getElementById("connectbtn"),darkTheme:document.getElementById("darkTheme"),myBrackets:document.getElementById("myBrackets"),createBracket:document.getElementById("createBracket"),importBracket:document.getElementById("importBracket"),browseBracket:document.getElementById("browseBracket"),bracketEditor:document.getElementById("bracketEditor"),bracketEditorHeader:document.getElementById("bracketEditorHeader"),bracketTitle:document.getElementById("bracketTitle"),bracketDescription:document.getElementById("bracketDescription"),optionContainer:document.getElementById("optionContainer"),addOption:document.getElementById("addOption"),toastContainer:document.getElementById("toastContainer"),main:document.getElementById("main"),brackets_editor:document.getElementById("brackets_editor"),hideScore:document.getElementById("hideScore"),hideScoreIcon:document.getElementById("hideScoreIcon"),title:document.getElementById("title"),round:document.getElementById("round"),left_container:document.getElementById("left_container"),right_container:document.getElementById("right_container"),left_title:document.getElementById("left_title"),right_title:document.getElementById("right_title"),left_card:document.getElementById("left_card"),right_card:document.getElementById("right_card"),left_card_zoom_icon:document.getElementById("left_card_zoom_icon"),right_card_zoom_icon:document.getElementById("right_card_zoom_icon"),left_name:document.getElementById("left_name"),right_name:document.getElementById("right_name"),left_score:document.getElementById("left_score"),right_score:document.getElementById("right_score"),left_command:document.getElementById("left_command"),right_command:document.getElementById("right_command"),left_value:document.getElementById("left_value"),right_value:document.getElementById("right_value"),left_info:document.getElementById("left_info"),right_info:document.getElementById("right_info"),controls:document.getElementById("controls"),enableVoting:document.getElementById("enableVoting"),end:document.getElementById("end"),endTitle:document.getElementById("endTitle"),winner_name:document.getElementById("winner_name"),winner_value:document.getElementById("winner_value"),endControls:document.getElementById("endControls")};const icons={text:'<i class="material-icons notranslate">description</i>',image:'<i class="material-icons notranslate">image</i>',youtube:'<i class="material-icons notranslate">play_arrow</i>',twitch:'<i class="material-icons notranslate">movie_creation</i>'},spinner='<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';let client,loginButton,loginExpiredModal,deleteBracketModal,quitBracketModal,previewModal,importModal,browseModal,startModal,votePopover,startID,darkTheme=!0,currentBracket={},voters=[],voting_enabled=!1,currentTime=0,vote_results={left:0,right:0},USER={channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""},BRACKETS={brackets:[]};function resetSettings(){return localStorage.setItem("USER",JSON.stringify({channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""})),localStorage.setItem("BRACKETS",JSON.stringify({brackets:[]})),location.reload(),!1}async function refreshData(){darkTheme=elements.darkTheme.checked??!0,USER.twitchLogin||(USER.channel=validator.escape(elements.channelName.value.replace(/\s+/g,"").toLowerCase()),USER.platform="twitch"),!USER.userID&&USER.channel&&(USER.userID=await getUserID(USER.channel))}function saveSettings(){refreshData(),localStorage.setItem("USER",JSON.stringify(USER)),localStorage.setItem("BRACKETS",JSON.stringify(BRACKETS)),localStorage.setItem("darkTheme",darkTheme)}async function loadAndConnect(){load_localStorage(),refreshData();const e=new Proxy(new URLSearchParams(window.location.search),{get:(e,t)=>e.get(t)});if(e.channel&&!USER.channel&&!USER.twitchLogin&&!USER.access_token&&!USER.userID){let t=e.channel.replace(/\s+/g,"").toLowerCase();elements.channelName.value=t,USER.channel=t,window.history.replaceState({},document.title,"/")}if(USER.twitchLogin&&!await checkToken(USER.access_token))return USER.channel="",void loginExpiredModal.show();USER.channel&&connect()}function load_localStorage(){localStorage.getItem("USER")&&(USER=JSON.parse(localStorage.getItem("USER")),elements.channelName.value=USER.channel),localStorage.getItem("BRACKETS")&&(BRACKETS=JSON.parse(localStorage.getItem("BRACKETS")),loadBrackets())}async function loadPFP(){if(!USER.channel)return void(elements.topRight.innerHTML=' <div class="btn-group" role="group" aria-label="login options">\n      <a\n        role="button"\n        id="loginButton"\n        class="btn btn-twitch"\n        tabindex="0"\n        data-bs-container="body"\n        data-bs-custom-class="custom-popover"\n        data-bs-placement="bottom"\n        data-bs-trigger="manual"\n        data-bs-toggle="popover"\n        data-bs-title="Not signed in"\n        data-bs-content="You need sign in first"\n        ><span class="twitch-icon"></span>Sign in with Twitch</a\n      >\n      <div class="btn-group" role="group">\n        <button\n          id="btnGroupDropLogin"\n          type="button"\n          class="btn btn-twitch dropdown-toggle"\n          data-bs-toggle="dropdown"\n          data-bs-auto-close="outside"\n          aria-label="other login option, connect manually"\n          aria-expanded="false"\n        ></button>\n        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="btnGroupDropLogin">\n          <div class="p-3" style="width: 300px">\n            <label for="channelName" class="form-label">Connect to chat directly</label>\n            <div class="input-group mb-3">\n              <span class="input-group-text" id="directLoginChannel">twitch.tv/</span>\n              <input type="text" class="form-control" id="channelName" aria-describedby="directLoginChannel" />\n            </div>\n            <small class="text-body-secondary">Some features will not be available if you connect directly</small><br />\n            <button type="button" id="connectbtn" class="btn btn-primary float-end">Connect</button>\n          </div>\n        </div>\n      </div>\n    </div>');let e=await get7TVPFP(USER.userID);"/pics/donk.png"==e&&USER.access_token&&(e=await getTwitchPFP(USER.channel,USER.access_token)),elements.topRight.innerHTML=`\n    <div class="btn-group" role="group" aria-label="Button group with nested dropdown">\n    <button type="button" id="btnGroupDrop2" class="btn btn-${darkTheme?"dark":"secondary"}"><img src="${e}" alt="profile pic" style="height:2em;"></button>\n    <div class="btn-group" role="group">\n    <button id="btnGroupDrop1" type="button" class="btn btn-${darkTheme?"dark":"secondary"} dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">\n    ${USER.channel}\n    </button>\n    <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n    <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n    </ul>\n    </div>\n    </div>`}function login(){return elements.topRight.innerHTML='<div class="btn-group" role="group" aria-label="log in button group">\n      <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n      <div class="btn-group" role="group">\n          <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">\n        </button>\n          <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDropLogin">\n              <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n          </ul>\n      </div>\n  </div>',window.open("/prompt.html","loginWindow","toolbar=0,status=0,scrollbars=0,width=500px,height=800px"),!1}function checkLogin(){return!!USER.channel||(loginButton.show(),setTimeout((function(){loginButton.hide()}),4e3),!1)}function logout(){elements.topRight.innerHTML=' <div class="btn-group" role="group" aria-label="login options">\n    <a\n      role="button"\n      id="loginButton"\n      class="btn btn-twitch"\n      tabindex="0"\n      data-bs-container="body"\n      data-bs-custom-class="custom-popover"\n      data-bs-placement="bottom"\n      data-bs-trigger="manual"\n      data-bs-toggle="popover"\n      data-bs-title="Not signed in"\n      data-bs-content="You need sign in first"\n      ><span class="twitch-icon"></span>Sign in with Twitch</a\n    >\n    <div class="btn-group" role="group">\n      <button\n        id="btnGroupDropLogin"\n        type="button"\n        class="btn btn-twitch dropdown-toggle"\n        data-bs-toggle="dropdown"\n        data-bs-auto-close="outside"\n        aria-label="other login option, connect manually"\n        aria-expanded="false"\n      ></button>\n      <div class="dropdown-menu dropdown-menu-end" aria-labelledby="btnGroupDropLogin">\n        <div class="p-3" style="width: 300px">\n          <label for="channelName" class="form-label">Connect to chat directly</label>\n          <div class="input-group mb-3">\n            <span class="input-group-text" id="directLoginChannel">twitch.tv/</span>\n            <input type="text" class="form-control" id="channelName" aria-describedby="directLoginChannel" />\n          </div>\n          <small class="text-body-secondary">Some features will not be available if you connect directly</small><br />\n          <button type="button" id="connectbtn" class="btn btn-primary float-end">Connect</button>\n        </div>\n      </div>\n    </div>\n  </div>',resetSettings()}function connect(){elements.status.innerHTML='\n    <h4>\n    <span class="badge bg-warning">Connecting... \n    <div class="spinner-border" style="width:18px;height:18px;" role="status"><span class="visually-hidden">Loading...</span></div>\n    </span>\n    </h4>',elements.topRight.innerHTML='\n    <div class="btn-group" role="group" aria-label="log in button group">\n    <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n    <div class="btn-group" role="group">\n    <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"></button>\n    <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n    <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n    </ul>\n    </div>\n    </div>',refreshData();let e={options:{clientId:CLIENT_ID,debug:!1},connection:{secure:!0,reconnect:!0},channels:[USER.channel]};client=new tmi.client(e),client.on("message",(async(e,t,n,o)=>{let a=n.split(" ").filter(Boolean)[0].toLowerCase();if(voting_enabled){if(!voters.includes(t["user-id"]))return a==currentCommand.left?(vote_results.left++,voters.push(t["user-id"]),void updateScores()):a==currentCommand.right?(vote_results.right++,voters.push(t["user-id"]),void updateScores()):void 0}else("1"==a||"a"==a||"2"==a||"b"==a)&&(Date.now()-currentTime)/1e3>10&&(currentTime=Date.now(),votePopover.show(),setTimeout((function(){votePopover.hide()}),2e3))})),client.on("timeout",((e,t,n,o,a)=>{})),client.on("connected",(async(e,t)=>{elements.status.innerHTML='<h4><span class="badge bg-success">Connected :)</span></h4>',saveSettings(),sendUsername("chat.vote/brackets",USER.channel,"twitch"==USER.platform?`twitch - ${USER.twitchLogin}`:"youtube"),await checkTags(USER.userID,USER.access_token)&&(elements.vtsLink.style.display=""),loadPFP()})),client.on("disconnected",(e=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${e}</span></h4>`})),client.on("notice",((e,t,n)=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${n}</span></h4>`})),client.connect().catch(console.error)}function switchTheme(e){document.documentElement.setAttribute("data-bs-theme",e?"dark":"light"),document.getElementById("twitchLogo").style.filter=`invert(${e?.25:.65})`,document.getElementById("btnGroupDrop1")&&document.getElementById("btnGroupDrop2")&&(document.getElementById("btnGroupDrop1").classList.remove(""+(e?"btn-secondary":"btn-dark")),document.getElementById("btnGroupDrop1").classList.add(""+(e?"btn-dark":"btn-secondary")),document.getElementById("btnGroupDrop2").classList.remove(""+(e?"btn-secondary":"btn-dark")),document.getElementById("btnGroupDrop2").classList.add(""+(e?"btn-dark":"btn-secondary")))}function addOption(e="",t="",n=""){let o=++document.querySelectorAll(".option-name").length,a="text";o>1&&(a=Array.from(document.getElementsByClassName("option-type")).find((e=>parseInt(e.dataset.optionId,10)===o-1)).value||"text"),t&&(a=t),elements.optionContainer.insertAdjacentHTML("beforeend",`<div class="card mb-2" data-option-id="${o}">\n      <div class="card-header">\n      Option #${o}\n      <i class="material-icons notranslate  deletebtn float-end" onclick="deleteOption('${o}')">delete_forever</i>\n      </div>\n      <div class="card-body">\n        <div class="input-group mb-3">\n          <span class="input-group-text">Name</span>\n          <input type="text" class="form-control option-name" data-option-id="${o}" onchange="saveBracket()" value="${e}"  placeholder="Option Name" aria-label="Option Name" />\n        </div>\n\n        <div class="input-group mb-3">\n          <label class="input-group-text">Type</label>\n          <select class="form-select option-type" data-option-id="${o}" onchange="saveBracket()">\n            <option value="text" ${"text"==a?"selected":""}>Text</option>\n            <option value="image" ${"image"==a?"selected":""}>Image</option>\n            <option value="youtube" ${"youtube"==a?"selected":""}>YouTube video</option>\n            <option value="twitch" ${"twitch"==a?"selected":""}>Twitch clip</option>\n          </select>\n          <button class="btn btn-outline-secondary" onclick="previewOption(${o})" type="button">Preview</button>\n        </div>\n\n        <div class="input-group mb-3">\n          <span class="input-group-text option-value-label">Value</span>\n          <input type="text" class="form-control option-value" data-option-id="${o}" onchange="saveBracket()" value="${n}" placeholder="Option Value" aria-label="Option Value" />\n        </div>\n\n      </div>\n    </div>`)}function deleteOption(e){e=parseInt(e,10);let t=parseInt(elements.bracketTitle.dataset.bracketId,10),n=BRACKETS.brackets.findIndex((e=>e.id===t));BRACKETS.brackets[n].options.splice(e-1,1),editBracket(t)}function previewOption(e){e=parseInt(e,10);let t=document.querySelectorAll(".option-name"),n=document.querySelectorAll(".option-type"),o=document.querySelectorAll(".option-value"),a=(Array.from(t).find((t=>t.dataset.optionId==e)),Array.from(n).find((t=>t.dataset.optionId==e))),r=Array.from(o).find((t=>t.dataset.optionId==e));if("text"==a.value&&(elements.previewModalBody.innerHTML=`\n    <div class="card">\n    <div class="card-body">${r?.value||'<span class="text-body-secondary">Empty option</span>'}</div>\n    </div>`,previewModal.show()),"image"==a.value){let e=r?.value.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g)||null;if(!e)return void showToast("Invalid image URL","warning",3e3);elements.previewModalBody.innerHTML=`\n    <div class="card">\n    <div class="card-body">\n    <img src="https://proxy.pepega.workers.dev/?url=${encodeURI(e)}" alt="option preview" style="max-height: 480px">\n    </div>\n    </div>`,previewModal.show()}if("youtube"==a.value){let e=/(youtu.*be.*)\/(watch\?v=|embed\/|v|shorts|)(.*?((?=[&#?])|$))/gm.exec(r?.value)||null;if(!e)return void showToast("Invalid YouTube URL","warning",3e3);e=e[3],elements.previewModalBody.innerHTML=`\n    <div class="card">\n    <div class="card-body">\n    <iframe \n    id="ytplayer" \n    type="text/html" \n    width="100%" height="480" \n    src="https://www.youtube.com/embed/${e}?autoplay=1&origin=https://chat.vote" \n    frameborder="0">\n    </iframe>\n    </div>\n    </div>`,previewModal.show()}if("twitch"==a.value)try{let e=new URL(r?.value),t="clips.twitch.tv"===e.hostname?/^\/(\w+(?:\/[A-Z]\w+)?(?:[\-\w]*))(?:\/|$)/.exec(e.pathname):/^\/\w+\/clip\/(\w+(?:\/[A-Z]\w+)?(?:[\-\w]*))(?:\/|$)/.exec(e.pathname);if(!t[1])return void showToast("Invalid Twitch clip URL","warning",3e3);elements.previewModalBody.innerHTML=`\n      <div class="card">\n      <div class="card-body">\n      <iframe \n      src="https://clips.twitch.tv/embed?clip=${t[1]}&parent=chat.vote&autoplay=true" \n      height="480" \n      width="100%" \n      preload="auto" \n      >\n      </iframe>\n      </div>\n      </div>`,previewModal.show()}catch(e){return void showToast("Invalid Twitch clip URL","warning",3e3)}}function createBracket(e=!1){let t=0;0!==BRACKETS?.brackets?.length&&(t=BRACKETS.brackets.reduce(((e,t)=>e.id>t.id?e:t)).id),BRACKETS.brackets.push({id:++t,title:"",description:"",options:[],imported:e,time:Date.now()}),editBracket(t),saveBracket()}function saveBracket(){let e=parseInt(elements.bracketTitle.dataset.bracketId,10),t=BRACKETS.brackets.find((t=>t.id===e));t.title=elements.bracketTitle.value||"Untitled bracket",t.description=elements.bracketDescription.value||"No description";let n=document.querySelectorAll(".option-name"),o=document.querySelectorAll(".option-type"),a=document.querySelectorAll(".option-value");t.options=[];for(let e=0;e<n.length;e++)t.options.push({name:n[e].value,type:o[e].value,value:a[e].value});loadBrackets(),saveSettings()}function showStartModal(e){startID=e,startModal.show()}function startBracket(){let e=parseInt(startID,10),t=structuredClone(BRACKETS.brackets.find((t=>t.id===e)));if(t.options.length<2)return void showToast("Bracket must have 2 options at least","warning",3e3);let n=parseInt(elements.optionLimit.value,10)||0;if(n>0)for(;t.options.length>n;)t.options.splice(Math.floor(Math.random()*t.options.length),1);let o=Math.ceil(Math.log2(t.options.length)),a=t.options.length;if(0!=(a&a-1)){let e=1;for(;e<a;)e<<=1;a=e}currentBracket={},currentBracket.round1=[...t.options],shuffleArray(currentBracket.round1);let r=0;for(;currentBracket.round1.length<a;)currentBracket.round1.splice(currentBracket.round1.length-2*r,0,null),r++;for(let e=1;e<=o;e++)currentBracket[`round${e+1}`]=[...Array(currentBracket[`round${e}`].length/2)];elements.brackets_editor.style.display="none",elements.main.style.display="",elements.title.innerHTML=t.title,elements.endTitle.innerHTML=`<h1 class="display-6">Winner of ${t.title}</h1>`,currentRound=1,currentOption=0,currentScores={left:0,right:0},currentCommand={left:"a",right:"b"},nextMatch(),changeSiteLinkTarget("_blank")}let left_player,right_player,currentRound=1,currentOption=0,currentScores={left:0,right:0},currentCommand={left:"a",right:"b"};function nextMatch(){currentOption==currentBracket[`round${currentRound}`].length&&(currentRound++,currentOption=0);let e="";switch(currentBracket[`round${currentRound}`].length){case 2:e="Finals";break;case 4:e="Semifinals";break;case 8:e="Quarterfinals";break;default:e=`Round of ${currentBracket[`round${currentRound}`].length}`;break}if(elements.round.innerHTML=`${e} • ${currentOption/2+1}/${currentBracket[`round${currentRound}`].length/2}`,Object.keys(currentBracket).length==currentRound)return void showWinner(currentBracket[`round${currentRound}`]);let t=currentBracket[`round${currentRound}`][currentOption++],n=currentBracket[`round${currentRound}`][currentOption++];if(null!==t)if(null!==n){showOption("left",t),showOption("right",n);for(let e of document.getElementsByClassName("streamer-vote"))e.style.display="";vote_results={left:0,right:0},voters=[],updateScores(),elements.keepVotingEnabled.checked||disableVoteButton(),elements.left_card.style="",elements.right_card.style="",elements.left_title.style="",elements.right_title.style="",elements.changeCommand.checked?"a"==currentCommand.left?(currentCommand.left="1",currentCommand.right="2"):(currentCommand.left="a",currentCommand.right="b"):(currentCommand.left="1",currentCommand.right="2"),elements.left_command.innerHTML=currentCommand.left,elements.right_command.innerHTML=currentCommand.right,elements.disableAnimations.checked||(anime({targets:"#left_title",translateX:["-100%",0]}),anime({targets:"#left_card",translateX:["-100%",0]}),anime({targets:"#right_title",translateX:["200%",0]}),anime({targets:"#right_card",translateX:["200%",0]}),elements.changeCommand.checked&&anime({targets:["#left_command","#right_command"],keyframes:[{fontSize:"+=20px"},{fontSize:"-=20px"}],delay:2e3,duration:500}))}else promoteOption(t);else promoteOption(n)}function streamerVote(e){vote_results[e]++,voters.push(USER.userID),updateScores();for(let e of document.getElementsByClassName("streamer-vote"))e.style.display="none"}function pickWinner(e=null){let t=currentBracket[`round${currentRound}`][currentOption-2],n=currentBracket[`round${currentRound}`][currentOption-1],o=e;null==o&&(o=vote_results.left>vote_results.right?"left":"right"),vote_results.left!=vote_results.right||e?promoteOption(e=e?"left"==e?t:n:vote_results.left>vote_results.right?t:n,o):showToast("Options are tied, can't pick a winner","warning",3e3)}function restartMatch(){vote_results={left:0,right:0},voters=[],updateScores();for(let e of document.getElementsByClassName("streamer-vote"))e.style.display=""}function promoteOption(e,t=null){let n=currentBracket[`round${currentRound+1}`].findIndex((e=>void 0===e));currentBracket[`round${currentRound+1}`][n]=e,t&&!elements.disableAnimations.checked?(anime({targets:`#${"right"==t?"left":"right"}_title`,translateY:"2000px",scale:"0.8",duration:1e3}),anime({targets:`#${"right"==t?"left":"right"}_card`,translateY:"2000px",scale:"0.8",duration:1e3}),anime({targets:`#${t}_title`,translateX:[{value:("right"==t?"-":"+")+"110%",duration:500}],translateY:[{value:"-50%",duration:500},{value:"-200%",duration:500}],scale:[{value:"1.2",duration:500}]}),anime({targets:`#${t}_card`,translateX:[{value:("right"==t?"-":"+")+"50%",duration:500}],translateY:[{value:"50%",duration:500}],scale:[{value:"1.2",duration:500}],translateY:[{value:"-2000px",duration:500,delay:500}],complete:function(e){nextMatch()}})):nextMatch()}function showOption(e,t){if(elements[`${e}_name`].innerHTML=t.name||'<span class="text-body-secondary">Untitled option</span>',"text"==t.type&&(elements[`${e}_value`].innerHTML=t.value||'<span class="text-body-secondary">Empty option</span>'),"image"==t.type){let n=t?.value.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g)||null;if(!n)return void(elements[`${e}_value`].innerHTML="Invalid image URL");elements[`${e}_value`].innerHTML=`<img src="https://proxy.pepega.workers.dev/?url=${encodeURI(n)}" alt="${e} option" style="max-height: 480px">`}if("youtube"==t.type){let n=/(youtu.*be.*)\/(watch\?v=|embed\/|v|shorts|)(.*?((?=[&#?])|$))/gm.exec(t?.value)||null;if(!n)return void(elements[`${e}_value`].innerHTML="Invalid YouTube URL");n=n[3],elements[`${e}_value`].innerHTML=`\n    <iframe \n    id="${e}_youtube" \n    type="text/html" \n    width="100%" height="480" \n    src="https://www.youtube.com/embed/${n}?enablejsapi=1&origin=https://chat.vote" \n    frameborder="0">\n    </iframe>`,"left"==e?left_player=new YT.Player("left_youtube",{events:{onReady:e=>{e.target.playVideo()},onStateChange:e=>{}}}):right_player=new YT.Player("right_youtube",{events:{onReady:e=>{},onStateChange:e=>{}}})}if("twitch"==t.type)try{let n=new URL(t?.value),o="clips.twitch.tv"===n.hostname?/^\/(\w+(?:\/[A-Z]\w+)?(?:[\-\w]*))(?:\/|$)/.exec(n.pathname):/^\/\w+\/clip\/(\w+(?:\/[A-Z]\w+)?(?:[\-\w]*))(?:\/|$)/.exec(n.pathname);if(!o[1])return void(elements[`${e}_value`].innerHTML="Invalid Twitch clip URL");elements[`${e}_value`].innerHTML=`\n      <iframe \n      src="https://clips.twitch.tv/embed?clip=${o[1]}&parent=chat.vote&autoplay=${"left"==e}" \n      height="480" \n      width="100%" \n      preload="auto" \n      >\n      </iframe>`}catch(t){return void(elements[`${e}_value`].innerHTML="Invalid Twitch clip URL")}}function updateScores(){scoreHidden?(elements.left_score.innerHTML='<span class="text-body-secondary">Score hidden</span>',elements.right_score.innerHTML='<span class="text-body-secondary">Score hidden</span>'):(elements.left_score.innerHTML=`${vote_results.left.toLocaleString()} ${1==vote_results.left?"vote":"votes"}`,elements.right_score.innerHTML=`${vote_results.right.toLocaleString()} ${1==vote_results.right?"vote":"votes"}`)}function showWinner(e){showOption("winner",e[0]),elements.left_value.innerHTML="",elements.right_value.innerHTML="",elements.main.style.display="none",elements.end.style.display=""}function toggleVoting(){voting_enabled?disableVoteButton():enableVoteButton()}function enableVoteButton(){elements.enableVoting.classList.remove("btn-success"),elements.enableVoting.classList.add("btn-danger"),elements.enableVoting.innerText="Stop Voting",voting_enabled=!0}function disableVoteButton(){elements.enableVoting.classList.remove("btn-danger"),elements.enableVoting.classList.add("btn-success"),elements.enableVoting.innerText="Start Voting",voting_enabled=!1}function quitBracket(){elements.main.style.display="none",elements.end.style.display="none",elements.brackets_editor.style.display="",elements.left_value.innerHTML="",elements.right_value.innerHTML="",elements.winner_value.innerHTML="",quitBracketModal.hide(),changeSiteLinkTarget("_self")}function editBracket(e){elements.bracketEditor.style.display="",elements.optionContainer.innerHTML="",e=parseInt(e,10);let t=BRACKETS.brackets.find((t=>t.id===e));t&&(elements.bracketTitle.value=t.title,elements.bracketTitle.dataset.bracketId=e,elements.bracketDescription.value=t.description),elements.bracketEditorHeader.innerHTML=`ID${e}`;for(let e=0;e<t.options.length;e++)addOption();let n=document.querySelectorAll(".option-name"),o=document.querySelectorAll(".option-type"),a=document.querySelectorAll(".option-value");for(let e=0;e<n.length;e++)n[e].value=t.options[e].name,o[e].value=t.options[e].type,a[e].value=t.options[e].value}function deleteBracket(e){e=parseInt(e,10);let t=BRACKETS.brackets.find((t=>t.id===e));elements.deleteBracketModalBody.innerHTML=`Delete "${t.title}"?`,elements.deleteBracketButton.dataset.bracketId=e,deleteBracketModal.show()}function loadBrackets(){if(!BRACKETS?.brackets?.length)return void(elements.myBrackets.innerHTML='<span class="text-body-secondary">Nothing here</span>');let e="";for(let t=BRACKETS.brackets.length-1;t>=0;t--)e+=`<div class="card mb-3">\n    <div class="card-header">\n      ${BRACKETS.brackets[t].title||"Untitled bracket"}\n      <div class="btn-group btn-group-sm float-end" role="group" aria-label="bracket controls">\n        <button type="button" class="btn btn-success"\n         data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Start bracket" onclick="showStartModal(${BRACKETS.brackets[t].id})">\n          <i class="material-icons notranslate">play_arrow</i>\n        </button>\n        <button type="button" class="btn btn-secondary" ${BRACKETS.brackets[t]?.imported?'style="display: none"':""}\n        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Publish bracket" onclick="publishBracket(${BRACKETS.brackets[t].id},this)">\n         <i class="material-icons notranslate">cloud_upload</i>\n       </button>\n        <button type="button" class="btn btn-primary"\n         data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Edit bracket" onclick="editBracket(${BRACKETS.brackets[t].id})">\n        <i class="material-icons notranslate">edit</i>\n        </button>\n        <button type="button" class="btn btn-danger"\n         data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Delete bracket" onclick="deleteBracket(${BRACKETS.brackets[t].id})">\n          <i class="material-icons notranslate">delete_forever</i>\n        </button>\n      </div>\n    </div>\n    <div class="card-body my-bracket-body">\n      <h5 class="card-title">${BRACKETS.brackets[t].description||"No description"}</h5>\n      <p class="card-text">${BRACKETS.brackets[t].options.map((e=>`${icons[e.type]} ${e.name}`)).join(" • ")||"No options"}</p>\n    </div>\n  </div>`;elements.myBrackets.innerHTML=e,enableTooltips()}function closeEditor(){saveBracket(),elements.bracketEditor.style.display="none"}function shuffleArray(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}let approvedBrackets,previewedBracket=[];async function previewImport(){let e=elements.importBracketType.value?.replace(/\s+/g,"")?.toLowerCase()||null,t=elements.importBracketValue.value?.replace(/\s+/g,"")?.toLowerCase()||null;if(e)if(t)if("chatvote"!=e||4===t.length){if("uwufufu"==e)try{let e=t.match(/\/quiz\/worldcup\/(.+?)(\/rank)?(\?.*)?$/)[1];if(24!==e.length)return void showToast("Could not find the provided bracket","warning",3e3);elements.importPreview.innerHTML=spinner;let n={method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},redirect:"follow"},o=await fetch(`https://brackets.pepega.workers.dev/import?id=${e}`,n),a=await o.json();previewedBracket=a.list;let r='<ul class="list-group">';for(let e=0;e<a?.list.length;e++)if(a.list[e]?.isVideo){if(!a.list[e].videoUrl)continue;r+=`\n          <li class="list-group-item">\n          <a target="_blank" rel="noopener noreferrer" href="${a.list[e].videoUrl}">${a.list[e].name||"Untitled option"}</a>\n          </li>`}else{if(!a.list[e].resourceUrl)continue;r+=`\n          <li class="list-group-item">\n          <a target="_blank" rel="noopener noreferrer" href="https://proxy.pepega.workers.dev/?url=${encodeURI(a.list[e].resourceUrl)}">${a.list[e].name||"Untitled option"}</a>\n          </li>`}r+="</ul>",elements.importPreview.innerHTML=r}catch(e){return void showToast("Could not find the provided bracket","warning",3e3)}}else showToast("Invalid bracket code","warning",3e3);else showToast("No bracket provided","warning",3e3);else showToast("No bracket type selected","warning",3e3)}async function importBracket(){let e=elements.importBracketType.value?.replace(/\s+/g,"")?.toLowerCase()||null,t=elements.importBracketValue.value?.replace(/\s+/g,"")?.toLowerCase()||null;if(e)if(t)if(0!=previewedBracket.length){createBracket(!0),elements.bracketTitle.value="Imported bracket",elements.bracketDescription.value=`Imported from ${elements.importBracketValue.value}`;for(let e=0;e<previewedBracket.length;e++)previewedBracket[e].isVideo&&!previewedBracket[e].videoUrl||(previewedBracket[e].isVideo||previewedBracket[e].resourceUrl)&&addOption(previewedBracket[e].name,previewedBracket[e].isVideo?"youtube":"image",previewedBracket[e].isVideo?previewedBracket[e].videoUrl:previewedBracket[e].resourceUrl);saveBracket(),importModal.hide()}else showToast("You must preview the bracket first","warning",3e3);else showToast("No bracket provided","warning",3e3);else showToast("No bracket type selected","warning",3e3)}async function importApproved(e){let t=approvedBrackets.find((t=>t.id===e));createBracket(!0),elements.bracketTitle.value=t.bracket.title,elements.bracketDescription.value=`${t.bracket.description} - Bracket by @${t.username} - bracket ID: ${t.id}`;for(let e=0;e<t.bracket.options.length;e++)addOption(t.bracket.options[e].name,t.bracket.options[e].type,t.bracket.options[e].value);saveBracket(),browseModal.hide()}async function publishBracket(e,t){t.innerHTML='<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>',e=parseInt(e,10);let n=BRACKETS.brackets.find((t=>t.id===e)),o={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({userid:USER.userID,username:USER.channel,access_token:USER.access_token,time:new Date,bracket:n}),redirect:"follow"};try{let e=await fetch("https://brackets.pepega.workers.dev/publish",o),n=await e.json();showToast(n.message,"info",3e3),t.innerHTML='<i class="material-icons notranslate">cloud_upload</i>'}catch(e){showToast("Could not publish bracket","danger",3e3),t.innerHTML='<i class="material-icons notranslate">cloud_upload</i>'}}async function loadApproved(){elements.browseModalBody.innerHTML=spinner,browseModal.show();let e={method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},redirect:"follow"};try{let t=await fetch("https://brackets.pepega.workers.dev/approved",e),n=await t.json();approvedBrackets=n;let o="";0==n.length&&(o="Could not find any brackets :(");for(let e=0;e<n.length;e++){o+=`\n      <div class="card mb-5">\n      <div class="card-header">${n[e].bracket.title} <span class="text-body-secondary">by @${n[e].username}</span></div>\n      <div class="card-body">\n      <p class="card-text">${n[e].bracket.description}</p>\n      Options(${n[e].bracket.options.length}):\n      <ul class="list-group" style="height: 200px; overflow: auto">`;for(let t=0;t<n[e].bracket.options.length;t++)o+=`<li class="list-group-item">${n[e].bracket.options[t].name} - ${n[e].bracket.options[t].value}</li>`;o+=`\n      </ul>\n      <button type="button" class="btn btn-success float-end mt-3 me-2" onclick="importApproved('${n[e].id}')">\n      <i class="material-icons notranslate">cloud_download</i> Import\n      </button>\n      </div>\n      </div>`}elements.browseModalBody.innerHTML=o,linkifyElementID("browseModalBody")}catch(e){elements.browseModalBody.innerHTML="Could not load brackets :("}}function zoomCard(e){elements[e].classList.toggle("zoomed"),elements[`${e}_zoom_icon`].innerHTML=elements[e].classList.contains("zoomed")?"zoom_out":"zoom_in",elements[e].classList.contains("zoomed")?anime({targets:`#${e}`,translateX:""+("left_card"==e?"+=50%":"-=50%"),scale:"+=0.6"}):anime({targets:`#${e}`,translateX:""+("left_card"==e?"-=50%":"+=50%"),scale:"-=0.6"})}let scoreHidden=!1;function hideScore(){if(scoreHidden=!scoreHidden,elements.hideScoreIcon.innerHTML=scoreHidden?"visibility_off":"visibility",scoreHidden)updateScores();else{let e={left:0,right:0};anime({targets:e,left:vote_results.left,right:vote_results.right,round:1,easing:"easeInOutExpo",update:function(){elements.left_score.innerHTML=`${e.left.toLocaleString()} ${1==e.left?"vote":"votes"}`,elements.right_score.innerHTML=`${e.right.toLocaleString()} ${1==e.right?"vote":"votes"}`}})}}function onYouTubeIframeAPIReady(){elements.left_value.addEventListener("mouseover",(e=>{try{left_player.getPlayerState()>=1&&right_player.getPlayerState()>=1&&(right_player.mute(),left_player.unMute())}catch(e){}})),elements.right_value.addEventListener("mouseover",(e=>{try{left_player.getPlayerState()>=1&&right_player.getPlayerState()>=1&&(left_player.mute(),right_player.unMute())}catch(e){}}))}window.onload=async function(){darkTheme="true"===(localStorage.getItem("darkTheme")||"true"),elements.darkTheme.checked=darkTheme??!0,switchTheme(elements.darkTheme.checked),loadAndConnect(),USER.channel||(loginButton=new bootstrap.Popover(elements.loginButton)),enableTooltips(),enablePopovers(),document.addEventListener("click",(e=>{!elements.left_card.contains(e.target)&&elements.left_card.classList.contains("zoomed")&&(elements.left_card.classList.remove("zoomed"),elements.left_card_zoom_icon.innerHTML="zoom_in",anime({targets:"#left_card",translateX:"-=50%",scale:"-=0.6"})),!elements.right_card.contains(e.target)&&elements.right_card.classList.contains("zoomed")&&(elements.right_card.classList.remove("zoomed"),elements.right_card_zoom_icon.innerHTML="zoom_in",anime({targets:"#right_card",translateX:"+=50%",scale:"-=0.6"}))})),votePopover=new bootstrap.Popover(elements.enableVoting),loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),deleteBracketModal=new bootstrap.Modal(elements.deleteBracketModal),quitBracketModal=new bootstrap.Modal(elements.quitBracketModal),previewModal=new bootstrap.Modal(elements.previewModal),importModal=new bootstrap.Modal(elements.importModal),browseModal=new bootstrap.Modal(elements.browseModal),startModal=new bootstrap.Modal(elements.startModal),elements.previewModal.addEventListener("hidden.bs.modal",(e=>{elements.previewModalBody.innerHTML=""})),elements.importModal.addEventListener("hidden.bs.modal",(e=>{elements.importPreview.innerHTML="",previewedBracket=[],elements.importBracketValue.value="",elements.importBracketType.value=""})),elements.channelName.addEventListener("keydown",(e=>{"Enter"===e.key&&connect()})),elements.darkTheme.onchange=function(){switchTheme(this.checked),saveSettings()},elements.importBracketType.onchange=function(){"chatvote"==this.value&&(elements.importBracketLabel.innerHTML="Bracket code",elements.importBracketValue.placeholder="XXXX"),"uwufufu"==this.value&&(elements.importBracketLabel.innerHTML="UwUFUFU link",elements.importBracketValue.placeholder="https://uwufufu.com/quiz/worldcup/XXXXXXXXXXXXXXXXXXXXXXXX")},elements.hideScore.addEventListener("click",(function(){bootstrap.Tooltip.getInstance("#hideScore").setContent({".tooltip-inner":scoreHidden?"Hide score":"Show score"}),hideScore()})),elements.connectbtn.addEventListener("click",(function(){connect()})),elements.loginExpiredRenew.addEventListener("click",(function(){login()})),elements.loginButton.addEventListener("click",(function(){login()})),elements.loginExpiredReset.addEventListener("click",(function(){resetSettings()})),elements.createBracket.addEventListener("click",(function(){createBracket(),enableTooltips()})),elements.importBracket.addEventListener("click",(function(){elements.importPreview.innerHTML="",previewedBracket=[]})),elements.browseBracket.addEventListener("click",(function(){})),elements.addOption.addEventListener("click",(function(){addOption()})),elements.deleteBracketButton.addEventListener("click",(function(){let e=parseInt(this.dataset.bracketId,10);BRACKETS.brackets.splice(BRACKETS.brackets.findIndex((t=>t.id===e)),1),loadBrackets(),saveSettings(),elements.bracketEditor.style.display="none",deleteBracketModal.hide(),enableTooltips()})),elements.bracketTitle.addEventListener("change",(function(){saveBracket()})),elements.bracketDescription.addEventListener("change",(function(){saveBracket()}));let e=document.createElement("script");e.src="https://www.youtube.com/iframe_api";let t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)};