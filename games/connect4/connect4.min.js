let _game,loginButton,loginExpiredModal,aboutModal,streamersTurn=!0,voters=[],elements={grid:document.getElementById("grid"),gameDiv:document.getElementById("gameDiv"),loginExpiredModal:document.getElementById("loginExpiredModal"),aboutModal:document.getElementById("aboutModal"),vtsLink:document.getElementById("vtsLink"),status:document.getElementById("status"),topRight:document.getElementById("topRight"),loginButton:document.getElementById("loginButton"),channelName:document.getElementById("channelName"),darkTheme:document.getElementById("darkTheme"),toastContainer:document.getElementById("toastContainer")},darkTheme=!0,USER={channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""},CONNECT4={ctx:document.getElementById("c4chartCanvas").getContext("2d"),chart:null,results:[{label:"1",data:0,c1:"#f44336",c2:"#f53337"},{label:"2",data:0,c1:"#f4c236",c2:"#f5c237"},{label:"3",data:0,c1:"#a8f436",c2:"#a9e437"},{label:"4",data:0,c1:"#36f443",c2:"#37e444"},{label:"5",data:0,c1:"#36f4c2",c2:"#37e4c3"},{label:"6",data:0,c1:"#36a8f4",c2:"#3798f5"},{label:"7",data:0,c1:"#4336f4",c2:"#4426f5"}]};function handleMessage(e,t,n,a){let o=n.split(" ").filter(Boolean);if(streamersTurn)return;let r=parseInt(o[0],10);if(!isNaN(r)&&r>0&&r<8&&!voters.includes(t.username)){voters.push(t.username);let e=CONNECT4.results.findIndex((e=>e.label==r));return CONNECT4.results[e].data+=1,void updateGraph("c4")}}function initGraph(){CONNECT4.chart&&CONNECT4.chart.destroy(),CONNECT4.chart=new Chart(CONNECT4.ctx,{type:"bar",data:{labels:["1 - 0 Votes (0%)","2 - 0 Votes (0%)","3 - 0 Votes (0%)","4 - 0 Votes (0%)","5 - 0 Votes (0%)","6 - 0 Votes (0%)","7 - 0 Votes (0%)"],datasets:[{label:"score",data:[],borderWidth:2}]},options:{indexAxis:"y",maintainAspectRatio:!1,scales:{x:{ticks:{color:"white"},beginAtZero:!0},y:{ticks:{textStrokeColor:"rgba(0,0,0,1)",textStrokeWidth:3,color:"white",mirror:!0,font:{size:32},z:1},beginAtZero:!0}},plugins:{tooltip:{enabled:!1},legend:{display:!1}}}})}function updateGraph(){let e,t,n,a;e=CONNECT4.results.map((e=>e.label)),t=CONNECT4.results.map((e=>e.data)),n=CONNECT4.results.map((e=>e.c1)),a=CONNECT4.results.map((e=>e.c2));let o=[],r=0;for(let r=0;r<t.length;r++)o.push({data:t[r],label:e[r],c1:n[r],c2:a[r]});for(let l=0;l<o.length;l++)t[l]=o[l].data,e[l]=`${o[l].label} - ${o[l].data} ${1==o[l].data?"Vote":"Votes"} (${Math.round(o[l].data/voters.length*100)||0}%)`,n[l]=o[l].c1,a[l]=o[l].c2,r+=o[l].data;document.getElementById("totalvotesc4").innerHTML=`Total votes: ${r}`,CONNECT4.chart.data.labels=e,CONNECT4.chart.data.datasets.forEach((e=>{e.data=t,e.backgroundColor=n,e.borderColor=a})),CONNECT4.chart.update()}function start(e,t){$("#board").empty();new C4({ai_1_strength:e,ai_2_strength:t,container:"#board"})}function reset(){document.getElementById("totalvotesc4").innerHTML="Total votes: 0",start(0,0),document.getElementById("c4chartCanvas").classList="blur",document.getElementById("c4overlay").innerHTML=`<span class="overlaytext">${USER.channel||"STREAMER"}'s turn</span>`,document.getElementById("c4output").innerHTML="",CONNECT4.results=[{label:"1",data:0,c1:"#f44336",c2:"#f53337"},{label:"2",data:0,c1:"#f4c236",c2:"#f5c237"},{label:"3",data:0,c1:"#a8f436",c2:"#a9e437"},{label:"4",data:0,c1:"#36f443",c2:"#37e444"},{label:"5",data:0,c1:"#36f4c2",c2:"#37e4c3"},{label:"6",data:0,c1:"#36a8f4",c2:"#3798f5"},{label:"7",data:0,c1:"#4336f4",c2:"#4426f5"}]}function playTurn(){if(0==voters.length)return;streamersTurn=!0;let e=document.getElementsByClassName("c4cols"),t=Array.prototype.slice.call(e).map((e=>parseInt(e.innerHTML,10)));document.getElementById("c4chartCanvas").classList="blur",document.getElementById("c4overlay").innerHTML=`<span class="overlaytext">${USER.channel||"STREAMER"}'s turn</span>`;let n=CONNECT4.results;n.sort((function(e,t){return e.data>t.data?-1:e.data==t.data?0:1}));for(let n=0,a=t.length;n<a;n++)e[n].innerHTML=0;_game.trigger("drop",{col_index:parseInt(n[0].label,10)-1}),voters=[];for(let e=0;e<CONNECT4.results.length;e++)CONNECT4.results[e].data=0;CONNECT4.results.sort((function(e,t){return parseInt(e.label,10)<parseInt(t.label,10)?-1:parseInt(e.label,10)==parseInt(t.label,10)?0:1})),updateGraph("c4")}window.onload=function(){darkTheme="true"===(localStorage.getItem("darkTheme")||"true"),elements.darkTheme.checked=darkTheme??!0,switchTheme(elements.darkTheme.checked),loadAndConnect(),USER.channel||(loginButton=new bootstrap.Popover(elements.loginButton)),loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),aboutModal=new bootstrap.Modal(elements.aboutModal),enableTooltips(),enablePopovers(),elements.channelName.addEventListener("keydown",(e=>{"Enter"===e.key&&connect()})),elements.darkTheme.onchange=function(){switchTheme(this.checked),saveSettings()},resetGame(),initGraph(),document.getElementById("c4overlay").innerHTML=`<span class="overlaytext">${USER.channel||"STREAMER"}'s turn</span>`};class C4{constructor(e){_game=this;let t=0,n={};this.current=null,this.rack=[],this.moves=[];class a{constructor(e){this.color=e,this.human=!0,this.toString=function(){return this===_game.current?"X":"O"}}}this.init=function(){for(let e=0;e<7;e++)this.rack[e]=new Array(6);let t=new a("streamer"),n=new a("chat");t.opponent=n,n.opponent=t,this.current=t,C4.Util(this),C4.UI(this,e),this.trigger("waitingForDrop")},this.on=function(e,t){e in n||(n[e]=[]),n[e].push(t)},this.trigger=function(e,t){if(!(e in n))return;let a=n[e];$.each(a,(function(e,n){n(t)}))},this.on("drop",(function(e){if(!e)return;let n=_game.util.getDropRow(e.col_index);if(n>-1){t++,_game.rack[e.col_index][n]=_game.current,_game.moves.push({player:_game.current,col_index:e.col_index,row_index:n});let a=_game.util.findConnected();a.length?_game.trigger("done",{winner:_game.current,connected:a}):42===t?_game.trigger("done"):(_game.current=_game.current.opponent,_game.trigger("waitingForDrop"))}})),this.init()}}function resetGame(){voters=[],initGraph(),streamersTurn=!0,reset()}C4.Util=function(e){let t=e.rack,n=t.length,a=t[0].length;e.util={findConnected:function(){let o=[],r=[[0,1],[-1,1],[1,1],[1,0]];return function(t){for(let o=0;o<n;o++)for(let n=0;n<a;n++){let a=e.rack[o][n];a&&a.color&&t(a,o,n)}}((function(e,n,a){$.each(r,(function(e,r){let l=function(e,n,a,o){let r=t[e][n],l=[[e,n]];try{for(;t[e+=a][n+=o]===r;)l.push([e,n])}catch(e){}return l}(n,a,r[0],r[1]);l.length>=4&&(o=o.concat(l))}))})),o},getDropRow:function(e){let n=t[e],o=a-1;for(;n[o];)o--;return o}}},C4.UI=function(e,t){let n,a,o,r=$(t.container);function l(){if(!e.moves.length)return;let t=e.moves[e.moves.length-1],n=t.col_index,o=t.row_index,r=$('<div class="coin col-'+n+" "+t.player.color+'" id="cell-'+n+"-"+o+'"/>');a.append(r),setTimeout((function(){r.addClass("row-"+o)}),50)}e.on("waitingForDrop",(function(){n.children().removeClass(e.current.opponent.color),n.children().addClass(e.current.color),n.toggleClass("enabled",e.current.human)})),e.on("waitingForDrop",l),e.on("done",(function(e){let t=$('<div class="message"/>');o.prepend(t),n.remove();let a="Draw";if(l(),e&&e.connected){for(let t=0;t<e.connected.length;t++){let n=e.connected[t][0],a=e.connected[t][1];$("#cell-"+n+"-"+a).addClass("connected")}a=e.winner.color+" wins"}t.text(a),document.getElementById("c4output").innerHTML=`${a}<br> <button type="button" onclick="resetGame()" class="btn btn-primary">Play again</button>`})),function(){o=$("<div class='rack'/>"),a=$("<div class='coins'></div>"),n=$("<div class='controls'></div>");let t=$('<div class="overlay"><img src="/games/connect4/overlay.svg" alt="overlay"></div>');for(let t=0;t<e.rack.length;t++)n.append(`<div class="control col-${t}"/><span class="collabel">${t+1}</span><span class="collabel2">${t+1}</span>`);n.on("click",".control",(function(){if(!streamersTurn)return;streamersTurn&&(document.getElementById("c4chartCanvas").classList="",document.getElementById("c4overlay").innerHTML="",streamersTurn=!1);let t=$(this).index();e.trigger("drop",{col_index:t})})),o.append(n),o.append(t),o.append(a),r.append(o)}()};