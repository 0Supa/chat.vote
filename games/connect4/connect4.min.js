const CLIENT_ID="qn0wimnszbqlwfnszdz3wwfz430eqr";let _game,streamersTurn=!0,voters=[],elements={grid:document.getElementById("grid"),gameDiv:document.getElementById("gameDiv"),loginExpiredModal:document.getElementById("loginExpiredModal"),loginExpiredRenew:document.getElementById("loginExpiredRenew"),loginExpiredReset:document.getElementById("loginExpiredReset"),howToPlayModal:document.getElementById("howToPlayModal"),aboutModal:document.getElementById("aboutModal"),vtsLink:document.getElementById("vtsLink"),status:document.getElementById("status"),topRight:document.getElementById("topRight"),loginButton:document.getElementById("loginButton"),channelName:document.getElementById("channelName"),connectbtn:document.getElementById("connectbtn"),darkTheme:document.getElementById("darkTheme"),toastContainer:document.getElementById("toastContainer")};const spinner='<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';let loginButton,loginExpiredModal,howToPlayModal,aboutModal,darkTheme=!0,USER={channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""};function refreshData(){darkTheme=elements.darkTheme.checked??!0,USER.twitchLogin||(USER.channel=elements.channelName.value.replace(/\s+/g,"").toLowerCase(),USER.platform="twitch")}function saveSettings(){refreshData(),localStorage.setItem("USER",JSON.stringify(USER)),localStorage.setItem("darkTheme",darkTheme)}function load_localStorage(){localStorage.getItem("USER")&&(USER=JSON.parse(localStorage.getItem("USER")),elements.channelName.value=USER.channel)}function resetSettings(){return localStorage.setItem("USER",JSON.stringify({channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""})),location.reload(),!1}function login(){return elements.topRight.innerHTML='<div class="btn-group" role="group" aria-label="log in button group">\n    <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n    <div class="btn-group" role="group">\n        <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">\n      </button>\n        <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n            <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n        </ul>\n    </div>\n</div>',window.open("/prompt.html","loginWindow","toolbar=0,status=0,scrollbars=0,width=500px,height=800px"),!1}function connect(){elements.status.innerHTML='\n  <h4>\n  <span class="badge bg-warning">Connecting... \n  <div class="spinner-border" style="width:18px;height:18px;" role="status"><span class="visually-hidden">Loading...</span></div>\n  </span>\n  </h4>',elements.topRight.innerHTML='\n  <div class="btn-group" role="group" aria-label="log in button group">\n  <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n  <div class="btn-group" role="group">\n  <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"></button>\n  <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n  <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n  </ul>\n  </div>\n  </div>',refreshData();let e={options:{clientId:CLIENT_ID,debug:!1},connection:{secure:!0,reconnect:!0},channels:[USER.channel]};client=new tmi.client(e),client.on("message",(async(e,t,n,o)=>{let a=n.split(" ").filter(Boolean);if(streamersTurn)return;let l=parseInt(a[0],10);if(!isNaN(l)&&l>0&&l<8&&!voters.includes(t.username)){voters.push(t.username);let e=CONNECT4.results.findIndex((e=>e.label==l));return CONNECT4.results[e].data+=1,void updateGraph("c4")}})),client.on("timeout",((e,t,n,o,a)=>{})),client.on("connected",(async(e,t)=>{elements.status.innerHTML='<h4><span class="badge bg-success">Connected :)</span></h4>',saveSettings(),sendUsername("chat.vote/games/donkhunt",USER.channel,"twitch"==USER.platform?`twitch - ${USER.twitchLogin}`:"youtube"),await checkTags(USER.userID,USER.access_token)&&(elements.vtsLink.style.display=""),loadPFP()})),client.on("disconnected",(e=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${e}</span></h4>`})),client.on("notice",((e,t,n)=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${n}</span></h4>`})),client.connect().catch(console.error)}async function loadPFP(){if(!USER.channel)return void(elements.topRight.innerHTML=' <div class="btn-group" role="group" aria-label="login options">\n    <a\n      role="button"\n      id="loginButton"\n      class="btn btn-twitch"\n      tabindex="0"\n      data-bs-container="body"\n      data-bs-custom-class="custom-popover"\n      data-bs-placement="bottom"\n      data-bs-trigger="manual"\n      data-bs-toggle="popover"\n      data-bs-title="Not signed in"\n      data-bs-content="You need sign in first before adding options or enabling voting/suggestions"\n      ><span class="twitch-icon"></span>Sign in with Twitch</a\n    >\n    <div class="btn-group" role="group">\n      <button\n        id="btnGroupDropLogin"\n        type="button"\n        class="btn btn-twitch dropdown-toggle"\n        data-bs-toggle="dropdown"\n        data-bs-auto-close="outside"\n        aria-label="other login option, connect manually"\n        aria-expanded="false"\n      ></button>\n      <div class="dropdown-menu dropdown-menu-end" aria-labelledby="btnGroupDropLogin">\n        <div class="p-3" style="width: 300px">\n          <label for="channelName" class="form-label">Connect to chat directly</label>\n          <div class="input-group mb-3">\n            <span class="input-group-text" id="directLoginChannel">twitch.tv/</span>\n            <input type="text" class="form-control" id="channelName" aria-describedby="directLoginChannel" />\n          </div>\n          <small class="text-body-secondary">Some features will not be available if you connect directly</small><br />\n          <button type="button" id="connectbtn" class="btn btn-primary float-end">Connect</button>\n        </div>\n      </div>\n    </div>\n  </div>');let e=await get7TVPFP(USER.userID);"/pics/donk.png"==e&&USER.access_token&&(e=await getTwitchPFP(USER.channel,USER.access_token)),elements.topRight.innerHTML=`\n  <div class="btn-group" role="group" aria-label="Button group with nested dropdown">\n  <button type="button" id="btnGroupDrop2" class="btn btn-${darkTheme?"dark":"secondary"}"><img src="${e}" alt="profile pic" style="height:2em;"></button>\n  <div class="btn-group" role="group">\n  <button id="btnGroupDrop1" type="button" class="btn btn-${darkTheme?"dark":"secondary"} dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">\n  ${USER.channel}\n  </button>\n  <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n  <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n  </ul>\n  </div>\n  </div>`}function checkLogin(){return!!USER.channel||(loginButton.show(),setTimeout((function(){loginButton.hide()}),4e3),!1)}function logout(){elements.topRight.innerHTML=' <div class="btn-group" role="group" aria-label="login options">\n  <a\n    role="button"\n    id="loginButton"\n    class="btn btn-twitch"\n    tabindex="0"\n    data-bs-container="body"\n    data-bs-custom-class="custom-popover"\n    data-bs-placement="bottom"\n    data-bs-trigger="manual"\n    data-bs-toggle="popover"\n    data-bs-title="Not signed in"\n    data-bs-content="You need sign in first before adding options or enabling voting/suggestions"\n    ><span class="twitch-icon"></span>Sign in with Twitch</a\n  >\n  <div class="btn-group" role="group">\n    <button\n      id="btnGroupDropLogin"\n      type="button"\n      class="btn btn-twitch dropdown-toggle"\n      data-bs-toggle="dropdown"\n      data-bs-auto-close="outside"\n      aria-label="other login option, connect manually"\n      aria-expanded="false"\n    ></button>\n    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="btnGroupDropLogin">\n      <div class="p-3" style="width: 300px">\n        <label for="channelName" class="form-label">Connect to chat directly</label>\n        <div class="input-group mb-3">\n          <span class="input-group-text" id="directLoginChannel">twitch.tv/</span>\n          <input type="text" class="form-control" id="channelName" aria-describedby="directLoginChannel" />\n        </div>\n        <small class="text-body-secondary">Some features will not be available if you connect directly</small><br />\n        <button type="button" id="connectbtn" class="btn btn-primary float-end">Connect</button>\n      </div>\n    </div>\n  </div>\n</div>',resetSettings()}function switchTheme(e){document.documentElement.setAttribute("data-bs-theme",e?"dark":"light"),document.getElementById("twitchLogo").style.filter=`invert(${e?.25:.65})`,document.getElementById("btnGroupDrop1")&&document.getElementById("btnGroupDrop2")&&(document.getElementById("btnGroupDrop1").classList.remove(""+(e?"btn-secondary":"btn-dark")),document.getElementById("btnGroupDrop1").classList.add(""+(e?"btn-dark":"btn-secondary")),document.getElementById("btnGroupDrop2").classList.remove(""+(e?"btn-secondary":"btn-dark")),document.getElementById("btnGroupDrop2").classList.add(""+(e?"btn-dark":"btn-secondary")))}async function loadAndConnect(){load_localStorage(),refreshData();const e=new Proxy(new URLSearchParams(window.location.search),{get:(e,t)=>e.get(t)});if(e.channel&&!USER.channel&&!USER.twitchLogin&&!USER.access_token&&!USER.userID){let t=e.channel.replace(/\s+/g,"").toLowerCase();elements.channelName.value=t,USER.channel=t,window.history.replaceState({},document.title,"/")}if(USER.twitchLogin&&!await checkToken(USER.access_token))return USER.channel="",void loginExpiredModal.show();USER.channel&&connect()}function toggleGrid(){elements.grid.style.display="none"==elements.grid.style.display?"":"none",elements.gameDiv.style.display=""==elements.gameDiv.style.display?"none":""}function showHowToPlay(){howToPlayModal.show()}function switchGame(e){switch(e){case"draw":location.href="/games/draw";break;case"arena":location.href="/games/arena";break;case"eb":location.href="/games/emotes";break;case"dh":location.href="/games/donkhunt";break;case"shapes":location.href="/games/shapes";break;case"nim":location.href="/games/nim";break;case"nw":location.href="/games/wordle";break;case"c4":location.href="/games/connect4";break;case"ttt":location.href="/games/tictactoe";break;case"about":aboutModal.show();break;default:break}}function initGraph(){CONNECT4.chart&&CONNECT4.chart.destroy(),CONNECT4.chart=new Chart(CONNECT4.ctx,{type:"bar",data:{labels:["1 - 0 Votes (0%)","2 - 0 Votes (0%)","3 - 0 Votes (0%)","4 - 0 Votes (0%)","5 - 0 Votes (0%)","6 - 0 Votes (0%)","7 - 0 Votes (0%)"],datasets:[{label:"score",data:[],borderWidth:2}]},options:{indexAxis:"y",maintainAspectRatio:!1,scales:{x:{ticks:{color:"white"},beginAtZero:!0},y:{ticks:{textStrokeColor:"rgba(0,0,0,1)",textStrokeWidth:3,color:"white",mirror:!0,font:{size:32},z:1},beginAtZero:!0}},plugins:{tooltip:{enabled:!1},legend:{display:!1}}}})}function updateGraph(){let e,t,n,o;e=CONNECT4.results.map((e=>e.label)),t=CONNECT4.results.map((e=>e.data)),n=CONNECT4.results.map((e=>e.c1)),o=CONNECT4.results.map((e=>e.c2));let a=[],l=0;for(let l=0;l<t.length;l++)a.push({data:t[l],label:e[l],c1:n[l],c2:o[l]});for(let s=0;s<a.length;s++)t[s]=a[s].data,e[s]=`${a[s].label} - ${a[s].data} ${1==a[s].data?"Vote":"Votes"} (${Math.round(a[s].data/voters.length*100)||0}%)`,n[s]=a[s].c1,o[s]=a[s].c2,l+=a[s].data;document.getElementById("totalvotesc4").innerHTML=`Total votes: ${l}`,CONNECT4.chart.data.labels=e,CONNECT4.chart.data.datasets.forEach((e=>{e.data=t,e.backgroundColor=n,e.borderColor=o})),CONNECT4.chart.update()}window.onload=function(){darkTheme="true"===(localStorage.getItem("darkTheme")||"true"),elements.darkTheme.checked=darkTheme??!0,switchTheme(elements.darkTheme.checked),loadAndConnect(),USER.channel||(loginButton=new bootstrap.Popover(elements.loginButton)),loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),howToPlayModal=new bootstrap.Modal(elements.howToPlayModal),aboutModal=new bootstrap.Modal(elements.aboutModal),enableTooltips(),enablePopovers(),elements.channelName.addEventListener("keydown",(e=>{"Enter"===e.key&&connect()})),elements.connectbtn.addEventListener("click",(function(){connect()})),elements.loginExpiredRenew.addEventListener("click",(function(){login()})),elements.loginButton.addEventListener("click",(function(){login()})),elements.loginExpiredReset.addEventListener("click",(function(){resetSettings()})),elements.darkTheme.onchange=function(){switchTheme(this.checked),saveSettings()},resetGame(),initGraph(),document.getElementById("c4overlay").innerHTML=`<span class="overlaytext">${USER.channel||"STREAMER"}'s turn</span>`},window.onbeforeunload=function(){return null};let CONNECT4={ctx:document.getElementById("c4chartCanvas").getContext("2d"),chart:null,results:[{label:"1",data:0,c1:"#f44336",c2:"#f53337"},{label:"2",data:0,c1:"#f4c236",c2:"#f5c237"},{label:"3",data:0,c1:"#a8f436",c2:"#a9e437"},{label:"4",data:0,c1:"#36f443",c2:"#37e444"},{label:"5",data:0,c1:"#36f4c2",c2:"#37e4c3"},{label:"6",data:0,c1:"#36a8f4",c2:"#3798f5"},{label:"7",data:0,c1:"#4336f4",c2:"#4426f5"}],start:function(e,t){$("#board").empty();new C4({ai_1_strength:e,ai_2_strength:t,container:"#board"})},reset:function(){document.getElementById("totalvotesc4").innerHTML="Total votes: 0",CONNECT4.start(0,0),document.getElementById("c4chartCanvas").classList="blur",document.getElementById("c4overlay").innerHTML=`<span class="overlaytext">${USER.channel||"STREAMER"}'s turn</span>`,document.getElementById("c4output").innerHTML="",CONNECT4.results=[{label:"1",data:0,c1:"#f44336",c2:"#f53337"},{label:"2",data:0,c1:"#f4c236",c2:"#f5c237"},{label:"3",data:0,c1:"#a8f436",c2:"#a9e437"},{label:"4",data:0,c1:"#36f443",c2:"#37e444"},{label:"5",data:0,c1:"#36f4c2",c2:"#37e4c3"},{label:"6",data:0,c1:"#36a8f4",c2:"#3798f5"},{label:"7",data:0,c1:"#4336f4",c2:"#4426f5"}]},playTurn:function(){if(0==voters.length)return;streamersTurn=!0;let e=document.getElementsByClassName("c4cols"),t=Array.prototype.slice.call(e).map((e=>parseInt(e.innerHTML,10)));document.getElementById("c4chartCanvas").classList="blur",document.getElementById("c4overlay").innerHTML=`<span class="overlaytext">${USER.channel||"STREAMER"}'s turn</span>`;let n=CONNECT4.results;n.sort((function(e,t){return e.data>t.data?-1:e.data==t.data?0:1}));for(let n=0,o=t.length;n<o;n++)e[n].innerHTML=0;_game.trigger("drop",{col_index:parseInt(n[0].label,10)-1}),voters=[];for(let e=0;e<CONNECT4.results.length;e++)CONNECT4.results[e].data=0;CONNECT4.results.sort((function(e,t){return parseInt(e.label,10)<parseInt(t.label,10)?-1:parseInt(e.label,10)==parseInt(t.label,10)?0:1})),updateGraph("c4")}};class C4{constructor(e){_game=this;let t=0,n={};this.current=null,this.rack=[],this.moves=[];class o{constructor(e){this.color=e,this.human=!0,this.toString=function(){return this===_game.current?"X":"O"}}}this.init=function(){for(let e=0;e<7;e++)this.rack[e]=new Array(6);let t=new o("streamer"),n=new o("chat");t.opponent=n,n.opponent=t,this.current=t,C4.Util(this),C4.UI(this,e),this.trigger("waitingForDrop")},this.on=function(e,t){e in n||(n[e]=[]),n[e].push(t)},this.trigger=function(e,t){if(!(e in n))return;let o=n[e];$.each(o,(function(e,n){n(t)}))},this.on("drop",(function(e){if(!e)return;let n=_game.util.getDropRow(e.col_index);if(n>-1){t++,_game.rack[e.col_index][n]=_game.current,_game.moves.push({player:_game.current,col_index:e.col_index,row_index:n});let o=_game.util.findConnected();o.length?_game.trigger("done",{winner:_game.current,connected:o}):42===t?_game.trigger("done"):(_game.current=_game.current.opponent,_game.trigger("waitingForDrop"))}})),this.init()}}function resetGame(){voters=[],initGraph(),streamersTurn=!0,CONNECT4.reset()}C4.Util=function(e){let t=e.rack,n=t.length,o=t[0].length;e.util={findConnected:function(){let a=[],l=[[0,1],[-1,1],[1,1],[1,0]];return function(t){for(let a=0;a<n;a++)for(let n=0;n<o;n++){let o=e.rack[a][n];o&&o.color&&t(o,a,n)}}((function(e,n,o){$.each(l,(function(e,l){let s=function(e,n,o,a){let l=t[e][n],s=[[e,n]];try{for(;t[e+=o][n+=a]===l;)s.push([e,n])}catch(e){}return s}(n,o,l[0],l[1]);s.length>=4&&(a=a.concat(s))}))})),a},getDropRow:function(e){let n=t[e],a=o-1;for(;n[a];)a--;return a}}},C4.UI=function(e,t){let n,o,a,l=$(t.container);function s(){if(!e.moves.length)return;let t=e.moves[e.moves.length-1],n=t.col_index,a=t.row_index,l=$('<div class="coin col-'+n+" "+t.player.color+'" id="cell-'+n+"-"+a+'"/>');o.append(l),setTimeout((function(){l.addClass("row-"+a)}),50)}e.on("waitingForDrop",(function(){n.children().removeClass(e.current.opponent.color),n.children().addClass(e.current.color),n.toggleClass("enabled",e.current.human)})),e.on("waitingForDrop",s),e.on("done",(function(e){let t=$('<div class="message"/>');a.prepend(t),n.remove();let o="Draw";if(s(),e&&e.connected){for(let t=0;t<e.connected.length;t++){let n=e.connected[t][0],o=e.connected[t][1];$("#cell-"+n+"-"+o).addClass("connected")}o=e.winner.color+" wins"}t.text(o),document.getElementById("c4output").innerHTML=`${o}<br> <button type="button" onclick="resetGame()" class="btn btn-primary">Play again</button>`})),function(){a=$("<div class='rack'/>"),o=$("<div class='coins'></div>"),n=$("<div class='controls'></div>");let t=$('<div class="overlay"><img src="/games/connect4/overlay.svg" alt="overlay"></div>');for(let t=0;t<e.rack.length;t++)n.append(`<div class="control col-${t}"/><span class="collabel">${t+1}</span><span class="collabel2">${t+1}</span>`);n.on("click",".control",(function(){if(!streamersTurn)return;streamersTurn&&(document.getElementById("c4chartCanvas").classList="",document.getElementById("c4overlay").innerHTML="",streamersTurn=!1);let t=$(this).index();e.trigger("drop",{col_index:t})})),a.append(n),a.append(t),a.append(o),l.append(a)}()};