let loginButton,loginExpiredModal,aboutModal,streamersTurn=!0,voters=[],elements={grid:document.getElementById("grid"),gameDiv:document.getElementById("gameDiv"),loginExpiredModal:document.getElementById("loginExpiredModal"),aboutModal:document.getElementById("aboutModal"),vtsLink:document.getElementById("vtsLink"),status:document.getElementById("status"),topRight:document.getElementById("topRight"),loginButton:document.getElementById("loginButton"),channelName:document.getElementById("channelName"),darkTheme:document.getElementById("darkTheme"),toastContainer:document.getElementById("toastContainer")},darkTheme=!0,USER={channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""};function handleMessage(e,t,n,a){let o=n.split(" ").filter(Boolean);if(streamersTurn)return;let l=parseInt(o[0],10);if(!isNaN(l)&&l>0&&l<4&&!voters.includes(t.username)){voters.push(t.username);let e=NIM.results.findIndex((e=>e.label==l));return NIM.results[e].data+=1,void updateGraph("nim")}}function initGraph(){NIM.chart&&NIM.chart.destroy(),NIM.chart=new Chart(NIM.ctx,{type:"bar",data:{labels:["1 - 0 Votes (0%)","2 - 0 Votes (0%)","3 - 0 Votes (0%)"],datasets:[{label:"score",data:[],borderWidth:2}]},options:{indexAxis:"y",maintainAspectRatio:!1,scales:{x:{ticks:{color:"white"},beginAtZero:!0},y:{ticks:{textStrokeColor:"rgba(0,0,0,1)",textStrokeWidth:3,color:"white",mirror:!0,font:{size:32},z:1},beginAtZero:!0}},plugins:{tooltip:{enabled:!1},legend:{display:!1}}}})}function updateGraph(){let e,t,n,a;e=NIM.results.map((e=>e.label)),t=NIM.results.map((e=>e.data)),n=NIM.results.map((e=>e.c1)),a=NIM.results.map((e=>e.c2));let o=[],l=0;for(let l=0;l<t.length;l++)o.push({data:t[l],label:e[l],c1:n[l],c2:a[l]});for(let r=0;r<o.length;r++)t[r]=o[r].data,e[r]=`${o[r].label} - ${o[r].data} ${1==o[r].data?"Vote":"Votes"} (${Math.round(o[r].data/voters.length*100)||0}%)`,n[r]=o[r].c1,a[r]=o[r].c2,l+=o[r].data;document.getElementById("totalvotesnim").innerHTML=`Total votes: ${l}`,NIM.chart.data.labels=e,NIM.chart.data.datasets.forEach((e=>{e.data=t,e.backgroundColor=n,e.borderColor=a})),NIM.chart.update()}window.onload=function(){darkTheme="true"===(localStorage.getItem("darkTheme")||"true"),elements.darkTheme.checked=darkTheme??!0,switchTheme(elements.darkTheme.checked),loadAndConnect(),USER.channel||(loginButton=new bootstrap.Popover(elements.loginButton)),loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),aboutModal=new bootstrap.Modal(elements.aboutModal),enableTooltips(),enablePopovers(),elements.channelName.addEventListener("keydown",(e=>{"Enter"===e.key&&connect()})),elements.darkTheme.onchange=function(){switchTheme(this.checked),saveSettings()},initGraph(),listeners(),document.getElementById("nimoverlay").innerHTML=`<span class="overlaytext">${USER.channel||"STREAMER"}'s turn</span>`};let NIM={ctx:document.getElementById("nimchartCanvas").getContext("2d"),chart:null,results:[{label:"1",data:0,c1:"#f44336",c2:"#f53337"},{label:"2",data:0,c1:"#f4c236",c2:"#f5c237"},{label:"3",data:0,c1:"#a8f436",c2:"#a9e437"}],html:{startGameBtn:document.querySelector("#nimstartGame"),restartGameBtn:document.querySelector("#nimrestartGame"),popCondition:document.querySelector("#popCondition"),popCountSlider:document.querySelector("#popCount"),popCountNumber:document.querySelector("#popCountX"),settings:document.querySelector("#nimsettings"),fieldrows:Array.from(document.querySelectorAll("#nimfield div.nim-field-row")),gamestate:document.querySelector("#nimgameState"),winmessage:document.querySelector("h4#nimwinMessage"),controls:document.querySelectorAll("div.nim-player-controls"),p1controls:Array.from(document.querySelectorAll("button.nim-p1-control")),p2controls:Array.from(document.querySelectorAll("button.nim-p2-control"))},game:{condition:"lose",initialCount:20,count:0,firstMove:0,turn:0}};function whoGoes(){return NIM.game.firstMove==NIM.game.turn%2?1:2}function setInitialCount(e){NIM.game.initialCount=Math.max(12,Math.min(36,parseInt(e.target.value,10))),NIM.html.popCountNumber.innerText=NIM.game.initialCount,NIM.game.count=NIM.game.initialCount,NIM.game.condition=NIM.html.popCondition.value||"lose",NIM.game.turn=0,NIM.html.fieldrows.forEach((e=>e.innerHTML="")),NIM.game.firstMove=Math.round(Math.random());let t=0;for(let e=0;e<NIM.game.count;e++){let e=document.createElement("div");e.classList.add("nim-popsicle"),e.style.filter=`hue-rotate(${360*Math.random()}deg)`,NIM.html.fieldrows[t].appendChild(e),t+=1,t>=NIM.html.fieldrows.length&&(t=0)}}function turn(){NIM.game.turn+=1,NIM.html.p1controls.forEach((e=>e.disabled=2==whoGoes())),NIM.html.p2controls.forEach((e=>e.disabled=1==whoGoes())),1==whoGoes()?(streamersTurn=!0,document.getElementById("nimchartCanvas").classList="blur",document.getElementById("nimoverlay").innerHTML=`<span class="overlaytext">${USER.channel||"STREAMER"}'s turn</span>`):(streamersTurn=!1,document.getElementById("nimchartCanvas").classList="",document.getElementById("nimoverlay").innerHTML="")}function makeMove(e){let t=0;if(streamersTurn)t=parseInt(e.target.dataset.intake,10);else{if(0==voters.length)return;t=getChatMove(),voters=[],NIM.results=[{label:"1",data:0,c1:"#f44336",c2:"#f53337"},{label:"2",data:0,c1:"#f4c236",c2:"#f5c237"},{label:"3",data:0,c1:"#a8f436",c2:"#a9e437"}],updateGraph("nim")}NIM.game.count-=t,turn(),NIM.game.count<1&&("win"==NIM.game.condition&&(NIM.game.turn+=1),NIM.html.winmessage.innerText=`${1==whoGoes()?USER.channel:"Chat"} wins!`,NIM.html.controls.forEach((e=>e.style.visibility="hidden")),NIM.html.gamestate.style.visibility="visible",NIM.html.settings.style.display="block"),NIM.html.fieldrows.forEach((e=>e.querySelectorAll("div.nim-popsicle.nim-last-taken").forEach((e=>e.classList.remove("nim-last-taken")))));const n=NIM.html.fieldrows.map((e=>Array.from(e.querySelectorAll("div.nim-popsicle"))));let a=Math.max(...n.map((e=>e.length))),o=n.length,l=2==whoGoes()?0:a-1,r=2==whoGoes()?0:o-1,s=2==whoGoes()?1:-1;for(;t>0&&(n[r].length>l&&(n[r][l].classList.contains("nim-taken")||(t-=1,n[r][l].classList.add("nim-taken","nim-last-taken"))),r+=s,!((r<0||r>=o)&&(r=2==whoGoes()?0:o-1,l+=s,l<0||l>=a))););}function getChatMove(){let e=NIM.results;return e.sort((function(e,t){return e.data>t.data?-1:e.data==t.data?0:1})),parseInt(e[0].label,10)}function startGame(){NIM.game.count=NIM.game.initialCount,NIM.game.condition=NIM.html.popCondition.value||"lose",NIM.game.turn=0,NIM.html.fieldrows.forEach((e=>e.innerHTML="")),NIM.game.firstMove=Math.round(Math.random()),1==NIM.game.firstMove?(streamersTurn=!0,document.getElementById("nimchartCanvas").classList="blur",document.getElementById("nimoverlay").innerHTML=`<span class="overlaytext">${USER.channel||"STREAMER"}'s turn</span>`):(streamersTurn=!1,document.getElementById("nimchartCanvas").classList="",document.getElementById("nimoverlay").innerHTML="");let e=0;for(let t=0;t<NIM.game.count;t++){let t=document.createElement("div");t.classList.add("nim-popsicle"),t.style.filter=`hue-rotate(${360*Math.random()}deg)`,NIM.html.fieldrows[e].appendChild(t),e+=1,e>=NIM.html.fieldrows.length&&(e=0)}NIM.html.gamestate.style.visibility="hidden",NIM.html.controls.forEach((e=>e.style.visibility="visible")),NIM.html.settings.style.display="none",turn()}function reset(){NIM.html.settings.style.display="block",NIM.results=[{label:"1",data:0,c1:"#f44336",c2:"#f53337"},{label:"2",data:0,c1:"#f4c236",c2:"#f5c237"},{label:"3",data:0,c1:"#a8f436",c2:"#a9e437"}],document.getElementById("nimoverlay").innerHTML=`<span class="overlaytext">${USER.channel||"STREAMER"}'s turn</span>`,document.getElementById("nimchartCanvas").classList="blur",NIM.game.count=NIM.game.initialCount,NIM.game.condition=NIM.html.popCondition.value||"lose",NIM.game.turn=0,NIM.html.fieldrows.forEach((e=>e.innerHTML=""));let e=0;for(let t=0;t<NIM.game.count;t++){let t=document.createElement("div");t.classList.add("nim-popsicle"),t.style.filter=`hue-rotate(${360*Math.random()}deg)`,NIM.html.fieldrows[e].appendChild(t),e+=1,e>=NIM.html.fieldrows.length&&(e=0)}NIM.html.gamestate.style.visibility="hidden"}function listeners(){NIM.html.popCountSlider.addEventListener("input",setInitialCount),NIM.html.startGameBtn.addEventListener("click",startGame),NIM.html.restartGameBtn.addEventListener("click",startGame),NIM.html.p1controls.forEach((e=>e.addEventListener("click",makeMove))),NIM.html.p2controls.forEach((e=>e.addEventListener("click",makeMove)))}