let loginButton,loginExpiredModal,aboutModal,voters=[],elements={grid:document.getElementById("grid"),gameDiv:document.getElementById("gameDiv"),loginExpiredModal:document.getElementById("loginExpiredModal"),aboutModal:document.getElementById("aboutModal"),vtsLink:document.getElementById("vtsLink"),status:document.getElementById("status"),topRight:document.getElementById("topRight"),loginButton:document.getElementById("loginButton"),channelName:document.getElementById("channelName"),connectbtn:document.getElementById("connectbtn"),darkTheme:document.getElementById("darkTheme"),toastContainer:document.getElementById("toastContainer")},darkTheme=!0,USER={channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""};function connect(){elements.status.innerHTML='\n  <h4>\n  <span class="badge bg-warning">Connecting... \n  <div class="spinner-border" style="width:18px;height:18px;" role="status"><span class="visually-hidden">Loading...</span></div>\n  </span>\n  </h4>',elements.topRight.innerHTML='\n  <div class="btn-group" role="group" aria-label="log in button group">\n  <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n  <div class="btn-group" role="group">\n  <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"></button>\n  <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n  <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n  </ul>\n  </div>\n  </div>',refreshData();let e={options:{clientId:CLIENT_ID,debug:!1},connection:{secure:!0,reconnect:!0},channels:[USER.channel]};client=new tmi.client(e),client.on("message",(async(e,t,s,n)=>{let a=s.split(" ").filter(Boolean),l=parseInt(a[0],10);if(!isNaN(l)&&l>0&&l<4&&!voters.includes(t.username)){voters.push(t.username);let e=SHAPES.results.findIndex((e=>e.label==l));return SHAPES.results[e].data+=1,void updateGraph("shapes")}})),client.on("timeout",((e,t,s,n,a)=>{})),client.on("connected",(async(e,t)=>{elements.status.innerHTML='<h4><span class="badge bg-success">Connected :)</span></h4>',saveSettings(),sendUsername("chat.vote/games/shapes",USER.channel,"twitch"==USER.platform?`twitch - ${USER.twitchLogin}`:"youtube"),await checkTags(USER.userID,USER.access_token)&&(elements.vtsLink.style.display=""),loadPFP()})),client.on("disconnected",(e=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${e}</span></h4>`})),client.on("notice",((e,t,s)=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${s}</span></h4>`})),client.connect().catch(console.error)}function initGraph(){SHAPES.chart&&SHAPES.chart.destroy(),SHAPES.chart=new Chart(SHAPES.ctx,{type:"bar",data:{labels:["1 - 0 Votes (0%)","2 - 0 Votes (0%)","3 - 0 Votes (0%)"],datasets:[{label:"score",data:[],borderWidth:2}]},options:{indexAxis:"y",maintainAspectRatio:!1,scales:{x:{ticks:{color:"white"},beginAtZero:!0},y:{ticks:{textStrokeColor:"rgba(0,0,0,1)",textStrokeWidth:3,color:"white",mirror:!0,font:{size:32},z:1},beginAtZero:!0}},plugins:{tooltip:{enabled:!1},legend:{display:!1}}}})}function updateGraph(){let e,t,s,n;e=SHAPES.results.map((e=>e.label)),t=SHAPES.results.map((e=>e.data)),s=SHAPES.results.map((e=>e.c1)),n=SHAPES.results.map((e=>e.c2));let a=[],l=0;for(let l=0;l<t.length;l++)a.push({data:t[l],label:e[l],c1:s[l],c2:n[l]});for(let i=0;i<a.length;i++)t[i]=a[i].data,e[i]=`${a[i].label} - ${a[i].data} ${1==a[i].data?"Vote":"Votes"} (${Math.round(a[i].data/voters.length*100)||0}%)`,s[i]=a[i].c1,n[i]=a[i].c2,l+=a[i].data;document.getElementById("totalvotesshapes").innerHTML=`Total votes: ${l}`,SHAPES.chart.data.labels=e,SHAPES.chart.data.datasets.forEach((e=>{e.data=t,e.backgroundColor=s,e.borderColor=n})),SHAPES.chart.update()}window.onload=function(){darkTheme="true"===(localStorage.getItem("darkTheme")||"true"),elements.darkTheme.checked=darkTheme??!0,switchTheme(elements.darkTheme.checked),loadAndConnect(),USER.channel||(loginButton=new bootstrap.Popover(elements.loginButton)),loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),aboutModal=new bootstrap.Modal(elements.aboutModal),enableTooltips(),enablePopovers(),elements.channelName.addEventListener("keydown",(e=>{"Enter"===e.key&&connect()})),elements.connectbtn.addEventListener("click",(function(){connect()})),elements.darkTheme.onchange=function(){switchTheme(this.checked),saveSettings()},initGraph(),listeners()};let SHAPES={field:document.getElementById("field"),figureList:Array.from(document.querySelectorAll("#field div.figure")),optionList:Array.from(document.querySelectorAll("#variants div.figure")),startBtn:document.querySelector("#startshapesbtn"),dVariants:document.querySelector("#variants"),dResult:document.querySelector("#shapesgameResult"),dDifficulty:document.querySelector("select#difficulty"),dStartingLives:document.querySelector("#startinglives"),lblStartingLives:document.querySelector("#startingliveslabel"),dShapesLength:document.getElementById("shapeslength"),lblShapesLength:document.getElementById("shapeslengthlabel"),lives:document.querySelector("#lives"),ctx:document.getElementById("shapeschartCanvas").getContext("2d"),chart:null,results:[{label:"1",data:0,c1:"#f44336",c2:"#f53337"},{label:"2",data:0,c1:"#f4c236",c2:"#f5c237"},{label:"3",data:0,c1:"#a8f436",c2:"#a9e437"}],shapesGame:{figs:[],choices:[],correct:-1,lives:0,difficulty:0,rule:null,gameStarted:!1}};function drawShapes(){SHAPES.figureList.forEach(((e,t)=>{const s=SHAPES.shapesGame.figs[t];e.classList="figure",s?(e.classList.add(s.size?"big":"small"),e.classList.add(s.type?"circle":"square2"),e.classList.add(s.color?"blue":"red")):(e.classList="figure unknown",t==SHAPES.shapesGame.figs.length&&e.classList.add("next"))})),SHAPES.shapesGame.gameStarted&&(SHAPES.optionList.forEach(((e,t)=>{const s=SHAPES.shapesGame.choices[t];e.classList="figure option",e.classList.add(s.size?"big":"small"),e.classList.add(s.type?"circle":"square2"),e.classList.add(s.color?"blue":"red"),s.isKnownToBeIncorrect()&&e.classList.add("unpickable")})),SHAPES.dVariants.style.visibility="visible",SHAPES.lives.innerHTML=`Lives: ${"‚ù§".repeat(SHAPES.shapesGame.lives)}`)}function generateChoices(){SHAPES.shapesGame.choices=new Array(3).fill(null),SHAPES.shapesGame.correct=Math.floor(Math.random()*SHAPES.shapesGame.choices.length),SHAPES.shapesGame.choices[SHAPES.shapesGame.correct]=SHAPES.shapesGame.rule.gen(SHAPES.shapesGame.figs[SHAPES.shapesGame.figs.length-1]);for(let e=0;e<SHAPES.shapesGame.choices.length;e++)for(;!SHAPES.shapesGame.choices[e];){let t=SHAPES.shapesGame.rule.fake(SHAPES.shapesGame.figs[SHAPES.shapesGame.figs.length-1]);SHAPES.shapesGame.choices.every((e=>!t.isEqual(e)))&&(SHAPES.shapesGame.choices[e]=t)}}function endGame(e=!1){e||(SHAPES.lives.innerHTML="Lives: üíÄ"),SHAPES.shapesGame.gameStarted=!1,document.querySelectorAll(".hide-after-game").forEach((e=>{e.style.display="none"})),document.querySelector("#endMessage").innerText=e?"Congrats! You've filled the row!":"YOU LOST! Wow, you are so bad at this game!",document.querySelector("#rule").innerText=SHAPES.shapesGame.rule.desc,SHAPES.dVariants.style.visibility="hidden",SHAPES.dResult.style.visibility="visible",SHAPES.startBtn.disabled=!1,SHAPES.dDifficulty.disabled=!1,SHAPES.dStartingLives.disabled=!1,SHAPES.dShapesLength.disabled=!1}function makeChoice(e){if(SHAPES.shapesGame.gameStarted)try{if(e.target.classList.contains("unpickable"))return;const t=parseInt(e.target.dataset.choice,10);t!==SHAPES.shapesGame.correct?(SHAPES.results=SHAPES.results.filter((function(e){return parseInt(e.label,10)!=t+1})),updateGraph("shapes"),SHAPES.shapesGame.lives-=1,SHAPES.shapesGame.choices[t].isKnownToBeIncorrect(!0),showToast("Incorrect choice!","danger",3e3),SHAPES.shapesGame.lives<1&&endGame(!1)):(SHAPES.results=[{label:"1",data:0,c1:"#f44336",c2:"#f53337"},{label:"2",data:0,c1:"#f4c236",c2:"#f5c237"},{label:"3",data:0,c1:"#a8f436",c2:"#a9e437"}],updateGraph("shapes"),SHAPES.shapesGame.figs.push(SHAPES.shapesGame.choices[SHAPES.shapesGame.correct]),SHAPES.shapesGame.figs.length>=SHAPES.figureList.length?endGame(!0):generateChoices()),drawShapes()}catch(e){}}function start(){SHAPES.dResult.style.visibility="hidden",SHAPES.dStartingLives.disabled=!0,SHAPES.dShapesLength.disabled=!0,SHAPES.startBtn.disabled=!0,SHAPES.dDifficulty.disabled=!0,document.querySelectorAll(".hide-after-game").forEach((e=>{e.style.display=""})),SHAPES.shapesGame.difficulty=parseInt(SHAPES.dDifficulty.value,10)||0,SHAPES.shapesGame.lives=parseInt(SHAPES.dStartingLives.value,10)||1;const e=rules[Object.keys(rules)[SHAPES.shapesGame.difficulty]];SHAPES.shapesGame.rule=e[Math.floor(Math.random()*e.length)],SHAPES.shapesGame.figs.length=0,SHAPES.shapesGame.figs.push(new Figure);for(let e=1;e<3;e++)SHAPES.shapesGame.figs.push(SHAPES.shapesGame.rule.gen(SHAPES.shapesGame.figs[SHAPES.shapesGame.figs.length-1]));SHAPES.shapesGame.gameStarted=!0,generateChoices(),drawShapes(),SHAPES.results=[{label:"1",data:0,c1:"#f44336",c2:"#f53337"},{label:"2",data:0,c1:"#f4c236",c2:"#f5c237"},{label:"3",data:0,c1:"#a8f436",c2:"#a9e437"}],updateGraph("shapes")}function reset(){SHAPES.dResult.style.visibility="hidden",SHAPES.startBtn.disabled=!1,SHAPES.dDifficulty.disabled=!1,SHAPES.shapesGame={figs:[],choices:[],correct:-1,lives:0,difficulty:0,rule:null,gameStarted:!1},SHAPES.results=[{label:"1",data:0,c1:"#f44336",c2:"#f53337"},{label:"2",data:0,c1:"#f4c236",c2:"#f5c237"},{label:"3",data:0,c1:"#a8f436",c2:"#a9e437"}]}function playTurn(){let e=SHAPES.results;e.sort((function(e,t){return e.data>t.data?-1:e.data==t.data?0:1})),SHAPES.optionList[parseInt(e[0].label,10)-1].click(),voters=[];for(let e=0;e<SHAPES.results.length;e++)SHAPES.results[e].data=0;SHAPES.results.sort((function(e,t){return parseInt(e.label,10)<parseInt(t.label,10)?-1:parseInt(e.label,10)==parseInt(t.label,10)?0:1})),updateGraph("shapes")}function listeners(){const e=function(){document.getElementById("lives").innerHTML=`Lives: ${"‚ù§".repeat(parseInt(this.value,10))}`,SHAPES.lblStartingLives.innerText=this.value};SHAPES.dStartingLives.oninput=e,SHAPES.dStartingLives.onchange=e,SHAPES.dStartingLives.dispatchEvent(new Event("change"));const t=function(){const e=parseInt(this.value,10)||5;for(SHAPES.lblShapesLength.innerText=e;field.firstChild;)field.removeChild(field.lastChild);const t=[];for(let s=0;s<e;s++){const e=document.createElement("div");e.classList="figure unknown",SHAPES.field.appendChild(e),t.push(e)}SHAPES.figureList=t};SHAPES.dShapesLength.oninput=t,SHAPES.dShapesLength.onchange=t,SHAPES.dShapesLength.dispatchEvent(new Event("change")),SHAPES.optionList.forEach((e=>e.addEventListener("click",makeChoice)))}class Figure{constructor(e,t,s){this.type=Boolean(null===e?Math.round(Math.random()):e),this.color=Boolean(null===t?Math.round(Math.random()):t),this.size=Boolean(null===s?Math.round(Math.random()):s)}isEqual(e){return!!e&&(this.type===e.type&&this.color===e.color&&this.size===e.size)}isKnownToBeIncorrect(e=!1){return e&&(this.isBad=!0),this.isBad||!1}}const rules={easy:[{desc:"Next figure must be of SAME COLOR as the last one",fake:e=>new Figure(null,!e.color,null),gen:e=>new Figure(null,e.color,null)},{desc:"Next figure must be of SAME SIZE as the last one",fake:e=>new Figure(null,null,!e.size),gen:e=>new Figure(null,null,e.size)},{desc:"Next figure must be of SAME SHAPE as the last one",fake:e=>new Figure(!e.type,null,null),gen:e=>new Figure(e.type,null,null)},{desc:"Next figure must be of DIFFERENT COLOR than the last one",fake:e=>new Figure(null,e.color,null),gen:e=>new Figure(null,!e.color,null)},{desc:"Next figure must be of DIFFERENT SIZE than the last one",fake:e=>new Figure(null,null,e.size),gen:e=>new Figure(null,null,!e.size)},{desc:"Next figure must be of DIFFERENT SHAPE than the last one",fake:e=>new Figure(e.type,null,null),gen:e=>new Figure(!e.type,null,null)}],normal:[{desc:"If last shape was SMALL, next one has to be BLUE, otherwise - RED",fake:e=>new Figure(null,e.size,null),gen:e=>new Figure(null,!e.size,null)},{desc:"If last shape was BIG, next one has to be SQUARE, otherwise - CIRCLE",fake:e=>new Figure(e.size,null,null),gen:e=>new Figure(!e.size,null,null)},{desc:"If last shape was BLUE, next one has to be CIRCLE, otherwise - SQUARE",fake:e=>new Figure(!e.color,null,null),gen:e=>new Figure(e.color,null,null)},{desc:"If last shape was CIRCLE, next one has to be BIG, otherwise - SMALL",fake:e=>new Figure(null,null,!e.type),gen:e=>new Figure(null,null,e.type)},{desc:"If last shape was BLUE, next one has to be SMALL, otherwise - BIG",fake:e=>new Figure(null,null,e.color),gen:e=>new Figure(null,null,!e.color)},{desc:"If last shape was CIRCLE, next one has to be SMALL, otherwise - BIG",fake:e=>new Figure(null,null,e.type),gen:e=>new Figure(null,null,!e.type)}],hard:[{desc:"If last shape was BIG, next one has to be BLUE, otherwise - of SAME TYPE as last shape",fake:e=>new Figure(e.size?null:!e.type,!e.size&&null,null),gen:e=>new Figure(e.size?null:e.type,!!e.size||null,null)},{desc:"If last shape was BIG, next one has to be BLUE, otherwise - of DIFFERENT COLOR than the last shape",fake:e=>new Figure(null,!e.size&&e.color,null),gen:e=>new Figure(null,!!e.size||!e.color,null)},{desc:"If last shape was BLUE, next one has to be BIG, otherwise - of DIFFERENT TYPE than the last shape",fake:e=>new Figure(e.color?null:e.type,null,!e.color&&null),gen:e=>new Figure(e.color?null:!e.type,null,!!e.color||null)},{desc:"If last shape was RED, next one has to be CIRCLE, otherwise - SMALL",fake:e=>new Figure(!!e.color&&null,null,!!e.color||null),gen:e=>new Figure(!e.color||null,null,!e.color&&null)}]};