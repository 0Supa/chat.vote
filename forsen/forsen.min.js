const USERNAME="forsen",pfp="https://static-cdn.jtvnw.net/jtv_user_pictures/forsen-profile_image-48b43e1e4f54b5c8-600x600.png",userid=22484632,raffle_command1="!join",raffle_command2="!ticket";let client,raffle_open,restartRaffleModal,fancyRaffleModal,raffleCollapse,tickSound,revealSound,elements={restartRaffleModal:document.getElementById("restartRaffleModal"),fancyRaffleModal:document.getElementById("fancyRaffleModal"),slot:document.getElementById("slot"),claw:document.getElementById("claw"),gameWinner:document.getElementById("gameWinner"),status:document.getElementById("status"),topRight:document.getElementById("topRight"),enableRaffle:document.getElementById("enableRaffle"),enableRaffleText:document.getElementById("enableRaffleText"),raffleAccordion:document.getElementById("raffleAccordion"),raffleCollapse:document.getElementById("raffleCollapse"),rafflePrefix:document.getElementById("rafflePrefix"),pussymode:document.getElementById("pussymode"),t3:document.getElementById("t3"),raffleUsersDiv:document.getElementById("raffleUsersDiv"),raffleUsers:document.getElementById("raffleUsers"),entrants:document.getElementById("entrants"),raffleOutput:document.getElementById("raffleOutput")},raffle_users=[],raffle_tickets=[],n=0,n2=0,n3=0,color="",currentTime=0,winner="",winners=[],thirdPartyEmotes=[];function restartRaffle(){raffle_users=[],raffle_tickets=[],winner="",winners=[],document.getElementById("countdown_raffle")&&document.getElementById("countdown_raffle").remove(),elements.raffleUsers.innerHTML="",elements.raffleOutput.innerHTML="",elements.entrants.innerHTML="Entrants: 0"}function connect(){elements.status.innerHTML='\n  <h4>\n  <span class="badge bg-warning">Connecting... \n  <div class="spinner-border" style="width:18px;height:18px;" role="status"><span class="visually-hidden">Loading...</span></div>\n  </span>\n  </h4>',elements.topRight.innerHTML='\n  <div class="btn-group" role="group" aria-label="log in button group">\n  <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n  <div class="btn-group" role="group">\n  <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"></button>\n  <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDropLogin">\n  <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n  </ul>\n  </div>\n  </div>',getEmotes(),loadBadges("forsen");let e={options:{clientId:CLIENT_ID,debug:!1},connection:{secure:!0,reconnect:!0},channels:["forsen"]};client=new tmi.client(e),client.on("message",(async(e,t,n,s)=>{let a=n.split(" ").filter(Boolean),o=a[0].toLowerCase();a.slice(1);if("!join"!=o&&"!ticket"!=o)t.username==winner&&raffleWinnerChat(t,n);else{if(!t.subscriber)return;if(elements.t3.checked&&4!=t?.badges?.subscriber?.length)return;if(!raffle_users.some((e=>e.username===t.username))&&!winners.includes(t.username)){addUserToRaffle({id:t["user-id"],username:t.username,displayname:t["display-name"],tickets:1,color:t.color,firstmsg:t["first-msg"],badges:t.badges,msg:n})}}})),client.on("timeout",((e,t,n,s,a)=>{if(t==winner){elements.raffleOutput.lastChild.innerHTML='<small class="text-body-secondary">Message deleted</small>'}})),client.on("connected",((e,t)=>{console.log(`Connected to ${e}:${t}`),elements.status.innerHTML='<h4><span class="badge bg-success">Connected :)</span></h4>',loadPFP()})),client.on("disconnected",(e=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${e}</span></h4>`})),client.on("notice",((e,t,n)=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${n}</span></h4>`})),client.connect().catch(console.error)}async function loadPFP(){elements.topRight.innerHTML=`\n  <div class="btn-group" role="group" aria-label="Button group with nested dropdown">\n  <button type="button" class="btn btn-dark"><img src="${pfp}" alt="profile pic" style="height:2em;"></button>\n  <div class="btn-group" role="group">\n  <button id="btnGroupDrop1" type="button" class="btn btn-dark dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">\n  forsen\n  </button>\n  <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n  <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n  </ul>\n  </div>\n  </div>`}async function addUserToRaffle(e){raffle_users.push(e);let t=e.username==e.displayname.toLowerCase()?`${e.displayname}`:`${e.displayname} (${e.username})`,n=e.color?e.color:"#FFFFFF",s=addBadges(e.badges,e.id,e.firstmsg),a=`<i class="material-icons notranslate deletebtn float-end" onclick="removeFromRaffle('${e.username}')">highlight_off</i>`;elements.raffleUsers.innerHTML=`<li id="${e.username}_raffle" class="list-group-item">\n  ${s}<span style="color:${n};"> ${t}</span>: ${e.tickets} ${1==e.tickets?"ticket":"tickets"} ${a}</li>`+elements.raffleUsers.innerHTML,elements.entrants.innerHTML=`Entrants: ${raffle_users.length}`}async function drawRaffleWinner(){if(raffle_users.length<2){let e=document.createElement("p");return e.innerHTML="Less than 2 users in raffle.",void elements.raffleOutput.append(e)}drawRaffleWinnerFancy()}class Slot{constructor(e,t,n){this.username=e,this.pfp=t||"/pics/donk.png",this.color=n||"#ffffff",this.measureUnit="px",this.ordinal=0,this.left=0,this.div=document.createElement("div"),this.div.classList.add("slot-element"),elements.pussymode.checked?this.div.innerHTML=`<span style="color:${this.color};"> ${this.username} </span>\n        <div style="height: 310px; width: 300px; border-bottom: 10px solid transparent; background: radial-gradient(circle, rgba(255,255,255,1) 0%, ${this.color} 100%);">\n          <img style="background: ${this.color}; height: 300px; width: 300px;" src="${this.pfp}" alt="${this.username}" title="${this.username}" />\n        </div>`:this.div.innerHTML=`<span style="color:${this.color};"> ${this.username} </span>\n        <div style="height: 310px; width: 300px; border-bottom: 10px solid transparent; background: radial-gradient(circle, rgba(255,255,255,1) 0%, ${this.color} 100%);">\n          <img\n            style="background: linear-gradient(0deg, ${this.color} 1%, rgba(100,100,100,1) 40%); height: 300px; width: 300px;"\n            src="${this.pfp}"\n            alt="${this.username}"\n            title="${this.username}"\n          />\n        </div>`}init(e=0){this.ordinal=-e}resetPosition(e=0){this.left=e,this.setPositionDOM(0)}scroll(e=0){this.left-=e,this.left<(this.ordinal-2)*app.animation.constants.ELEMENT_WIDTH&&(tickSound.play(),this.left+=app.slotOptions.length*app.animation.constants.ELEMENT_WIDTH),this.setPositionDOM(this.left)}setPositionDOM(e=0){this.div.style.left=e+this.measureUnit}checkEquatorPosition(){if(!this.div.parentNode)return void console.warn("Div is not attached to anything! Cannot calculate position!",this);const e=this.div.parentNode.getBoundingClientRect(),t=e.x+e.width/2,n=this.div.getBoundingClientRect(),s=[n.x,n.x+n.width];return s[0]<=t&&s[1]>=t}cloneSelf(){return new Slot(this.username,this.pfp,this.color)}destroy(){this.div.parentNode&&this.div.parentNode.removeChild(this.div)}}const detectWinner=function(){revealSound.play();let e=null;for(let t=0,n=app.slotOptions.length;t<n;t++)app.slotOptions[t].checkEquatorPosition()&&(e=app.slotOptions[t]);if(e){const t=e.cloneSelf();elements.gameWinner.appendChild(t.div),app.spinStarted=!1,winners.push(e.username),winner=e.username,removeFromRaffle(e.username);let n=document.createElement("p");n.classList.add("h2"),n.innerHTML=`Winner #${winners.length}: <a class="link-success cursorPointer" onclick=window.open("https://www.twitch.tv/popout/forsen/viewercard/${e.username}?popout=","_blank","width=340,height=800")>${e.username}</a>`,elements.raffleOutput.append(n),setTimeout((()=>{fancyRaffleModal.hide(),elements.gameWinner.innerHTML="",elements.slot.innerHTML='<div class="spinner-border" style="width: 10rem; height: 10rem; margin-left: auto; margin-right: auto; display:block;" role="status"><span class="visually-hidden">Loading...</span></div>'}),2e3)}else window.alert("Could not determine winner FeelsDonkMan")},animateRoll=function(){if(app.animation.speed+=app.animation.acceleration,app.animation.speed<0)app.animation.speed=0,app.animation.acceleration=0,setTimeout(detectWinner,1e3);else{for(let e=0,t=app.slotOptions.length;e<t;e++)app.slotOptions[e].scroll(app.animation.speed);window.requestAnimationFrame(animateRoll)}};Array.prototype.shuffle=function(){for(let e=this.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[this[e],this[t]]=[this[t],this[e]]}return this};const app={slotOptions:[],animation:{constants:{ELEMENT_WIDTH:310,SLOW_DOWN:-.1,STARTING_SPEED:40},acceleration:0,speed:0,projectedFPS:0},spinStarted:!1,ready:!1};async function drawRaffleWinnerFancy(){fancyRaffleModal.show(),elements.claw.style.display="none";let e=[];for(let t=0,n=raffle_users.length;t<n;t++)for(let n=raffle_users[t].tickets;n>0;n--)e.push(raffle_users[t]);e=e.shuffle().slice(0,100);for(let t=0,n=e.length;t<n;t++)e[t].pfp="/pics/raffledonk.png";for(let e=0,t=app.slotOptions.length;e<t;e++)app.slotOptions[e].destroy();app.slotOptions.length=0;for(let t=0,n=e.length;t<n;t++)app.slotOptions.push(new Slot(e[t].username,e[t].pfp,e[t].color));if(app.spinStarted)return;if(app.spinStarted=!0,app.slotOptions.length<1)return app.spinStarted=!1,window.alert("Nothing to spin!");for(;app.slotOptions.length<20;)for(let e=0,t=app.slotOptions.length;e<t;e++)app.slotOptions.push(app.slotOptions[e].cloneSelf());elements.gameWinner.innerHTML="",elements.slot.innerHTML="",elements.claw.style.display="block",app.slotOptions.shuffle().forEach(((e,t)=>{e.init(t),e.resetPosition(-20),elements.slot.appendChild(e.div)})),app.animation.speed=app.animation.constants.STARTING_SPEED;const t=60/app.animation.projectedFPS;app.animation.speed*=t,setTimeout((()=>{app.animation.acceleration=app.animation.constants.SLOW_DOWN,app.animation.acceleration*=t*t}),Math.round(1500+1e3*Math.random())),animateRoll()}const fpsBenchmark=function(){let e=performance.now(),t=0,n=0,s=!0;console.log("Performance test started.");const a=function(){let o=performance.now();t+=1,n=((t-1)*n-e+o)/t,e=o,s&&window.requestAnimationFrame(a)};a(),setTimeout((()=>{s=!1,app.animation.projectedFPS=1e3/n,console.info(`Performance test ended.\n- avg frame time: ${n}\n- projected FPS: ${app.animation.projectedFPS}\n- test frames drawn: ${t} in 1 sec`)}),1e3)};function raffleWinnerChat(e,t){let n=validator.escape(t);if(e.emotes){let s=[];for(const[n,a]of Object.entries(e.emotes))for(let e=0,o=a.length;e<o;e++){if(s.some((e=>e.id==n)))continue;let o=a[e].split("-");s.push({emote:t.substring(parseInt(o[0],10),parseInt(o[1],10)+1),id:n})}for(let e=0,t=s.length;e<t;e++){let t=`<img src="https://static-cdn.jtvnw.net/emoticons/v2/${s[e].id}/default/dark/1.0" title="${s[e].emote}" alt="${s[e].emote}" style="height:1.5em;">`;n=n.replaceAll(s[e].emote,t)}}n=replaceEmotes(n,thirdPartyEmotes);let s=e.username==e["display-name"].toLowerCase()?`${e["display-name"]}`:`${e["display-name"]} (${e.username})`,a=e.color?e.color:"#FFFFFF",o=addBadges(e.badges,e["user-id"],e.firstmsg),l=document.createElement("p");l.innerHTML=`${o}<span style="color:${a};"> ${s}:</span> ${n}`,elements.raffleOutput.append(l),linkifyElementID("raffleOutput",RAFFLES.linkPreviewThumbnailsEnabled)}function removeFromRaffle(e){raffle_users=raffle_users.filter((t=>t.username!==e)),document.getElementById(e+"_raffle").remove(),elements.entrants.innerHTML=`Entrants: ${raffle_users.length}`}async function getEmotes(){setTimeout((async()=>{let e=await getGlobalBTTVEmotes(),t=await getGlobalFFZEmotes(),n=await getGlobal7TVEmotes(),s=await getChannelBTTVEmotes(userid),a=await getChannelFFZEmotes(userid),o=await getChannel7TVEmotes(userid);thirdPartyEmotes=[...thirdPartyEmotes,...e,...t,...n,...s,...a,...o]}),3e3)}window.onload=async function(){connect(),fpsBenchmark(),restartRaffleModal=new bootstrap.Modal(elements.restartRaffleModal),fancyRaffleModal=new bootstrap.Modal(elements.fancyRaffleModal),enableTooltips(),tickSound=new Howl({src:["/raffles/tick.mp3"]}),revealSound=new Howl({src:["/raffles/reveal.mp3"]})},window.onbeforeunload=function(){};