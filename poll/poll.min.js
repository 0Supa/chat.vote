let pollModal,captchaModal,multipleAnswersAllowed,token,copyPopover,resultsVisibility="everyone",security="high",numberOfOptions=0,startingHue=360*Math.random(),elements={pollModal:document.getElementById("pollModal"),captchaModal:document.getElementById("captchaModal"),errorDiv:document.getElementById("errorDiv"),pollLinkDiv:document.getElementById("pollLinkDiv"),pollTitleDiv:document.getElementById("pollTitleDiv"),pollOptionsDiv:document.getElementById("pollOptionsDiv"),pollSettingsDiv:document.getElementById("pollSettingsDiv"),pollTitle:document.getElementById("pollTitle"),optionsDiv:document.getElementById("optionsDiv"),toastContainer:document.getElementById("toastContainer"),darkTheme:document.getElementById("darkTheme"),multipleAnswersAllowed:document.getElementById("multipleAnswersAllowed"),pollTimerValue:document.getElementById("pollTimerValue"),pollTimerUnit:document.getElementById("pollTimerUnit"),results_anyone:document.getElementById("results_anyone"),results_voters:document.getElementById("results_voters"),results_timer:document.getElementById("results_timer"),results_creator:document.getElementById("results_creator"),detect_low:document.getElementById("detect_low"),detect_high:document.getElementById("detect_high"),bulkOptions:document.getElementById("bulkOptions")},darkTheme=!0,POLL={multipleAnswersAllowed:!1,pollTimerValue:0,pollTimerUnit:"m",resultsVisibility:"everyone",security:"high"};const ckey="6LdzxrwdAAAAADyHX2t8ZS4U5QxTNLVWNrGOeNp0";function load_localStorage(){if(localStorage.getItem("POLL")){switch(POLL=JSON.parse(localStorage.getItem("POLL")),elements.multipleAnswersAllowed.checked=POLL.multipleAnswersAllowed??!1,elements.pollTimerValue.value=parseFloat(POLL.pollTimerValue)??0,parseFloat(POLL.pollTimerValue)>0&&(elements.results_timer.disabled=!1),elements.pollTimerUnit.value=POLL.pollTimerUnit||"m",POLL.resultsVisibility){case"everyone":elements.results_anyone.checked=!0,resultsVisibility="everyone";break;case"voters":elements.results_voters.checked=!0,resultsVisibility="voters";break;case"timer":elements.results_timer.checked=!0,resultsVisibility="timer";break;case"creator":elements.results_creator.checked=!0,resultsVisibility="creator";break;default:elements.results_anyone.checked=!0,resultsVisibility="everyone";break}switch(POLL.security){case"low":elements.detect_low.checked=!0,security="low";break;case"high":elements.detect_high.checked=!0,security="high";break;default:elements.detect_high.checked=!0,security="high";break}}else console.log("poll localStorage settings not found")}function refreshData(){darkTheme=elements.darkTheme.checked??!0,POLL.multipleAnswersAllowed=elements.multipleAnswersAllowed.checked,POLL.pollTimerValue=parseFloat(elements.pollTimerValue.value),POLL.pollTimerUnit=elements.pollTimerUnit.value,POLL.resultsVisibility=document.querySelector('input[name="resultsVisibility"]:checked').value,POLL.security=document.querySelector('input[name="duplicateDetectionLevel"]:checked').value}function saveSettings(){refreshData(),localStorage.setItem("POLL",JSON.stringify(POLL)),localStorage.setItem("darkTheme",darkTheme)}function reset(){numberOfOptions=0,startingHue=360*Math.random(),resetPollModal(),elements.optionsDiv.innerHTML="",addInput(),addInput(),changeSiteLinkTarget("_self")}function noDuplicates(){let e=[...document.querySelectorAll(".poll-option")].map((e=>e.value));return e.length===new Set(e).size}function checkEmpty(){let e=[...document.querySelectorAll(".poll-option")].map((e=>e.value)),t=[...new Set(e)];return!t[0]&&1==t.length}function removeDuplicates(e=!1){let t=[...document.querySelectorAll(".poll-option")],l=[...document.querySelectorAll(".remove-input")],n=[];for(let o=0;o<t.length;o++)n.includes(t[o].value)||e&&!t[o].value.replace(/\s+/g,"")?l[o].click():n.push(t[o].value)}function updateTimer(e){e.value>0?elements.results_timer.disabled=!1:(elements.results_timer.checked&&(elements.results_anyone.checked=!0),elements.results_timer.disabled=!0)}function copyLink(e){navigator.clipboard.writeText(e),copyPopover.show(),setTimeout((()=>{copyPopover.hide()}),1e3)}async function addOptionBulk(){resetPollModal();let e=elements.bulkOptions.value.split(/\r?\n/),t=[];for(let l=0;l<e.length;l++)!t.includes(e[l])&&e[l].replace(/\s+/g,"")&&t.push(e[l].trim());elements.bulkOptions.value="";for(let e=0,l=t.length;e<l;e++)addInput();let l=[...document.querySelectorAll(".poll-image")],n=[...document.querySelectorAll(".poll-option")],o=[...document.querySelectorAll(".remove-image")];for(let e=0,i=n.length;e<i;e++){let i=t[0];if(i&&!n[e].value&&(t.shift(),n[e].value=i,i.startsWith("http"))){let t={method:"GET",headers:{},redirect:"follow"};try{(await fetch(`https://helper.donk.workers.dev/cors/?${i.split(" ")[0]}`,t)).headers.get("Content-Type").startsWith("image")&&(l[e].innerHTML=`<div class="resizable"><img src="${i.split(" ")[0]}"></div>`,l[e].dataset.imageUrl=i.split(" ")[0],l[e].style.display="block",o[e].style.display="block",n[e].value=i.split(" ").slice(1).join(""))}catch(e){console.log(e)}}}removeDuplicates(!0)}function resetPollModal(){elements.errorDiv.innerHTML="",elements.pollLinkDiv.innerHTML='<p class="placeholder-glow">\n  <span class="placeholder placeholder-lg col-12 bg-warning"></span>\n  </p>',elements.pollTitleDiv.innerHTML='<p class="placeholder-glow">\n  <span class="placeholder col-12"></span>\n  </p>',elements.pollOptionsDiv.innerHTML='<p class="placeholder-glow">\n  <span class="placeholder col-12"></span>\n  </p>',elements.pollSettingsDiv.innerHTML='<p class="placeholder-glow">\n  <span class="placeholder col-12"></span>\n  </p>'}function checkSize(){let e=elements.pollTitle.value?elements.pollTitle.value:"Untitled poll",t=[...document.querySelectorAll(".poll-image")],l=[...document.querySelectorAll(".poll-option")],n=[...document.querySelectorAll(".option-color")],o=[],i=[];for(let e=0,s=l.length;e<s;e++)(l[e].value||t[e].dataset.imageUrl)&&(!l[e].value&&t[e].dataset.imageUrl?o.push({name:`Option #${e+1} with image`,type:"image",image:t[e].dataset.imageUrl,color:n[e].style.backgroundColor}):o.push({name:l[e].value,type:"text",image:t[e].dataset.imageUrl,color:n[e].style.backgroundColor}),i[e]=1e9);let s={id:"XXXXXXXX",title:"",description:"",questions:[{title:e,description:"",multipleChoice:multianswer,type:"poll",options:o}],scores:[i],votes:[[999999999999999]],resultsVisibility:"everyone",security:"high",endTime:999999999999999,createdAt:999999999999999,createdUsing:"chat.vote/poll",creatorip:"XXXX:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX",pollVersion:999999999999999};return(new TextEncoder).encode(JSON.stringify(s)).length/1024>100}async function createPoll(){if(checkEmpty())return void showToast("No poll options added","warning",3e3);if(noDuplicates()||removeDuplicates(),checkSize())return void showToast("Too many poll options","danger",3e3);let e,t=elements.multipleAnswersAllowed.checked;switch(elements.pollTimerUnit.value){case"m":e=Math.ceil(60*parseFloat(elements.pollTimerValue.value))||0;break;case"h":e=Math.ceil(3600*parseFloat(elements.pollTimerValue.value))||0;break;case"d":e=Math.ceil(86400*parseFloat(elements.pollTimerValue.value))||0;break;default:e=0}let l=elements.pollTitle.value?elements.pollTitle.value:"Untitled poll",n=[...document.querySelectorAll(".poll-image")],o=[...document.querySelectorAll(".poll-option")],i=[...document.querySelectorAll(".option-color")],s=[];for(let e=0,t=o.length;e<t;e++)(o[e].value||n[e].dataset.imageUrl)&&(!o[e].value&&n[e].dataset.imageUrl&&s.push({name:`Option #${e+1} with image`,type:"image",image:n[e].dataset.imageUrl,color:i[e].style.backgroundColor}),o[e].value&&n[e].dataset.imageUrl&&s.push({name:o[e].value,type:"image",image:n[e].dataset.imageUrl,color:i[e].style.backgroundColor}),o[e].value&&!n[e].dataset.imageUrl&&s.push({name:o[e].value,type:"text",image:n[e].dataset.imageUrl,color:i[e].style.backgroundColor}));if(s.length<2)showToast("You can't create a poll with less than 2 options","warning",3e3);else{resetPollModal(),pollModal.show();try{if(token=await grecaptcha.execute(ckey,{action:"submit"}),!token)return void captchaModal.show();let n={method:"POST",headers:{"Content-Type":"application/json"},redirect:"follow",body:JSON.stringify({captchatoken:token,title:"",description:"",resultsVisibility:resultsVisibility,security:security,endAfter:e,createdUsing:"chat..vote/poll",questions:[{title:l,description:"",multipleChoice:t,type:"poll",options:s}]})},o=await fetch("https://poll.chat.vote/api/create2",n),i=await o.json();if(console.log(i),200!=o.status)return void(elements.errorDiv.innerHTML=`Failed to create poll.<br>Error: ${i.message}`);window.open(`https://poll.chat.vote/${i.data.id}`,"_blank").focus(),elements.pollLinkDiv.innerHTML=`\n    <div class="input-group mb-3">\n      <input type="text" class="form-control" id="pollLink" onclick="copyLink('https://poll.chat.vote/${i.data.id}')" value="https://poll.chat.vote/${i.data.id}" />\n      <button\n        type="button"\n        id="copyLinkButton"\n        class="btn btn-outline-secondary"\n        data-bs-toggle="popover"\n        data-bs-trigger="manual"\n        data-bs-placement="bottom"\n        data-bs-content="Link copied :)"\n        onclick="copyLink('https://poll.chat.vote/${i.data.id}')">\n        <i class="material-icons notranslate">content_copy</i>\n      </button>\n    </div>`,copyPopover=new bootstrap.Popover(document.getElementById("copyLinkButton")),elements.pollTitleDiv.innerHTML=`\n    <ul class="list-unstyled">\n      <li>\n        <ul>\n          <li>${validator.escape(i.data.questions[0].title)}</li>\n        </ul>\n      </li>\n    </ul>`;let a='\n    <ul class="list-unstyled">\n      <li>\n        <ul>';for(let e=0,t=i.data.questions[0].options.length;e<t;e++)a+=`\n          <li>\n            ${validator.escape(i.data.questions[0].options[e].name)}\n          </li>`;a+="\n        </ul>\n      </li>\n    </ul>",elements.pollOptionsDiv.innerHTML=a;let r="";switch(i.data.resultsVisibility){case"everyone":r="Results visible to anyone";break;case"voters":r="Results visible voters only";break;case"timer":r=`Results will be revealed in ${Math.ceil((parseInt(i.data.endTime,10)-Date.now()/1e3)/60)} minutes`;break;case"creator":r="Results visible to you only";break}let c="No time limit";i.data.endTime&&(c=`Poll will close in ${Math.ceil((parseInt(i.data.endTime,10)-Date.now()/1e3)/60)} minutes`),elements.pollSettingsDiv.innerHTML=`\n    <ul class="list-unstyled">\n      <li>\n        <ul>\n          <li>${r}</li>\n          <li>${i.data.questions[0].multipleChoice?"Multiple answers allowed":"Multiple answers not allowed"}</li>\n          <li>${c}</li>\n          <li>Duplicate detection level: ${i.data.security}</li>\n        </ul>\n      </li>\n    </ul>`}catch(e){elements.errorDiv.innerHTML=`Failed to create poll.<br>Error: ${e}`}}}async function handleInput(e){let t=parseInt(e.target.dataset.optionId,10);if("Tab"===e.key&&e.preventDefault(),("ArrowUp"===e.key||"Tab"===e.key&&e.shiftKey)&&selectPreviousInput(t),("Enter"===e.key||"ArrowDown"===e.key||"Tab"===e.key&&!e.shiftKey)&&(selectNextInput(t),e.target.value.startsWith("http"))){let l=e.target.value,n={method:"GET",headers:{},redirect:"follow"};try{if((await fetch(`https://helper.donk.workers.dev/cors/?${l.split(" ")[0]}`,n)).headers.get("Content-Type").startsWith("image")){let e=[...document.querySelectorAll(".poll-image")],n=[...document.querySelectorAll(".poll-option")],o=[...document.querySelectorAll(".remove-image")],i=e.findIndex((e=>parseInt(e.dataset.optionId,10)===t));-1!=i&&(e[i].innerHTML=`<div class="resizable"><img src="${l.split(" ")[0]}"></div>`,e[i].dataset.imageUrl=l.split(" ")[0],e[i].style.display="block",o[i].style.display="block",n[i].value=l.split(" ").slice(1).join(""))}}catch(e){console.log(e)}}let l=[...document.querySelectorAll(".poll-option")];e.target.dataset.optionId==l[l.length-1].dataset.optionId&&e.target.value&&addInput(!1)}function selectPreviousInput(e){let t=[...document.querySelectorAll(".poll-option")],l=t.findIndex((t=>parseInt(t.dataset.optionId,10)===e));0==l?(elements.pollTitle.focus(),elements.pollTitle.select()):-1!=l&&(t[l-1].focus(),t[l-1].select())}function selectNextInput(e){let t=[...document.querySelectorAll(".poll-option")],l=t.findIndex((t=>parseInt(t.dataset.optionId,10)===e));l+1==t.length?addInput():-1!=l&&(t[l+1].focus(),t[l+1].select())}function addInput(e=!0){elements.optionsDiv.insertAdjacentHTML("beforeend",`\n    <div class="card bg-body-tertiary option-card" data-option-id="${++numberOfOptions}">\n      <div class="card-body option-card-body">\n        <div class="option-color" data-option-id="${numberOfOptions}" style="background-color: hsla(${Math.round(startingHue+=60*Math.random()+40)}, 100%, 50%, 0.8)"></div>\n        <div class="input-group">\n          <input type="text" class="form-control poll-option" onkeydown="handleInput(event)" data-option-id="${numberOfOptions}" placeholder="Enter poll option" aria-label="Poll option" />\n          <span class="input-group-text poll-image" data-option-id="${numberOfOptions}" data-image-url="" style="display: none"></span>\n          <button type="button" class="remove-image btn btn-warning" onclick="deleteImage(event)" data-option-id="${numberOfOptions}" style="display: none">\n            <i data-option-id="${numberOfOptions}" class="material-icons notranslate">hide_image</i>\n          </button>\n          <button type="button" class="remove-input btn btn-danger" onclick="deleteInput(event)" data-option-id="${numberOfOptions}">\n           <i class="material-icons notranslate" data-option-id="${numberOfOptions}">delete_forever</i>\n         </button>\n        </div>\n      </div>\n    </div>`),e&&selectNextInput(numberOfOptions-1),changeSiteLinkTarget("_blank")}function deleteInput(e){let t=[...document.querySelectorAll(".option-card")],l=t.findIndex((t=>parseInt(t.dataset.optionId,10)===parseInt(e.target.dataset.optionId,10)));-1!=l&&(t.length>2?t[l].remove():showToast("You can't have less than 2 options","danger",3e3))}function deleteImage(e){let t=[...document.querySelectorAll(".poll-image")],l=[...document.querySelectorAll(".remove-image")],n=t.findIndex((t=>parseInt(t.dataset.optionId,10)===parseInt(e.target.dataset.optionId,10)));-1!=n&&(t[n].innerHTML="",t[n].dataset.imageUrl="",t[n].style.display="none",l[n].style.display="none")}function switchTheme(e){document.documentElement.setAttribute("data-bs-theme",e?"dark":"light"),document.getElementById("twitchLogo").style.filter=`invert(${e?.25:.65})`}window.onload=function(){let e=new URL(window.location.href).searchParams.get("p");e?window.location.href=`https://poll.chat.vote/${e}`:(darkTheme="true"===(localStorage.getItem("darkTheme")||"true"),elements.darkTheme.checked=darkTheme??!0,switchTheme(elements.darkTheme.checked),elements.optionsDiv.innerHTML="",addInput(),addInput(),load_localStorage(),refreshData(),pollModal=new bootstrap.Modal(elements.pollModal),captchaModal=new bootstrap.Modal(elements.captchaModal),enableTooltips(),enablePopovers(),elements.pollTitle.addEventListener("keydown",(function(e){if("Tab"===e.key&&e.preventDefault(),"Enter"===e.key||"ArrowDown"===e.key||"Tab"===e.key){let e=[...document.querySelectorAll(".poll-option")];e[0].focus(),e[0].select()}})),elements.darkTheme.onchange=function(){switchTheme(this.checked),saveSettings()},elements.results_anyone.onchange=function(){this.checked&&(resultsVisibility="everyone"),saveSettings()},elements.results_voters.onchange=function(){this.checked&&(resultsVisibility="voters"),saveSettings()},elements.results_timer.onchange=function(){this.checked&&(resultsVisibility="timer"),saveSettings()},elements.results_creator.onchange=function(){this.checked&&(resultsVisibility="creator"),saveSettings()},elements.pollTimerValue.onchange=function(){updateTimer(this),saveSettings()},elements.multipleAnswersAllowed.onchange=function(){this.checked&&(multipleAnswersAllowed=!0),saveSettings()},elements.detect_low.onchange=function(){this.checked&&(security="low"),saveSettings()},elements.detect_high.onchange=function(){this.checked&&(security="high"),saveSettings()},elements.pollTitle.focus(),elements.pollTitle.select())};