let deleteAllModal,pollModal,captchaModal,multipleAnswersAllowed,token,copyTooltip,mode=0,level=1,numberOfOptions=2,elements={deleteAllModal:document.getElementById("deleteAllModal"),pollModal:document.getElementById("pollModal"),captchaModal:document.getElementById("captchaModal"),errorDiv:document.getElementById("errorDiv"),pollLinkDiv:document.getElementById("pollLinkDiv"),pollTitleDiv:document.getElementById("pollTitleDiv"),pollOptionsDiv:document.getElementById("pollOptionsDiv"),pollSettingsDiv:document.getElementById("pollSettingsDiv"),pollTitle:document.getElementById("pollTitle"),optionsDiv:document.getElementById("optionsDiv"),toastContainer:document.getElementById("toastContainer"),darkTheme:document.getElementById("darkTheme"),multipleAnswersAllowed:document.getElementById("multipleAnswersAllowed"),pollTimerValue:document.getElementById("pollTimerValue"),pollTimerUnit:document.getElementById("pollTimerUnit"),results_anyone:document.getElementById("results_anyone"),results_voters:document.getElementById("results_voters"),results_timer:document.getElementById("results_timer"),results_creator:document.getElementById("results_creator"),detect_low:document.getElementById("detect_low"),detect_high:document.getElementById("detect_high"),bulkOptions:document.getElementById("bulkOptions")},darkTheme=!0,POLL={multipleAnswersAllowed:!1,pollTimerValue:0,pollTimerUnit:"m",mode:0,level:1};const ckey="6LdzxrwdAAAAADyHX2t8ZS4U5QxTNLVWNrGOeNp0";function load_localStorage(){if(localStorage.getItem("POLL")){switch(POLL=JSON.parse(localStorage.getItem("POLL")),elements.multipleAnswersAllowed.checked=POLL.multipleAnswersAllowed??!1,elements.pollTimerValue.value=parseFloat(POLL.pollTimerValue)??0,parseFloat(POLL.pollTimerValue)>0&&(elements.results_timer.disabled=!1),elements.pollTimerUnit.value=POLL.pollTimerUnit||"m",parseInt(POLL.mode,10)){case 0:elements.results_anyone.checked=!0,mode=0;break;case 1:elements.results_voters.checked=!0,mode=1;break;case 2:elements.results_timer.checked=!0,mode=2;break;case 3:elements.results_creator.checked=!0,mode=3;break;default:elements.results_anyone.checked=!0,mode=0;break}switch(parseInt(POLL.level,10)){case 0:elements.detect_low.checked=!0,level=0;break;case 1:elements.detect_high.checked=!0,level=1;break;default:elements.detect_high.checked=!0,level=1;break}}else console.log("poll localStorage settings not found")}function refreshData(){darkTheme=elements.darkTheme.checked??!0,POLL.multipleAnswersAllowed=elements.multipleAnswersAllowed.checked,POLL.pollTimerValue=parseFloat(elements.pollTimerValue.value),POLL.pollTimerUnit=elements.pollTimerUnit.value,POLL.mode=parseInt(document.querySelector('input[name="resultsVisibility"]:checked').value,10),POLL.level=parseInt(document.querySelector('input[name="duplicateDetectionLevel"]:checked').value,10)}function saveSettings(){refreshData(),localStorage.setItem("POLL",JSON.stringify(POLL)),localStorage.setItem("darkTheme",darkTheme)}function showDeleteAllModal(){deleteAllModal.show()}function reset(){numberOfOptions=2,resetPollModal(),elements.optionsDiv.innerHTML='\n  <div class="card bg-body-tertiary option-card" data-option-id="1">\n  <div class="card-body">\n    <div class="input-group">\n      <input type="text" class="form-control poll-option" onkeydown="handleInput(event)" data-option-id="1" placeholder="Enter poll option" aria-label="Poll option" />\n      <span class="input-group-text poll-image" data-option-id="1" data-image-url="" style="display: none"> </span>\n      <button type="button" class="remove-image btn btn-warning" onclick="deleteImage(event)" data-option-id="1" style="display: none">\n        <i data-option-id="1" class="material-icons notranslate">hide_image</i>\n      </button>\n      <button type="button" class="remove-input btn btn-danger" onclick="deleteInput(event)" data-option-id="1">\n        <i class="material-icons notranslate" data-option-id="1">delete_forever</i>\n      </button>\n    </div>\n  </div>\n</div>\n<div class="card bg-body-tertiary option-card" data-option-id="2">\n  <div class="card-body">\n    <div class="input-group">\n      <input type="text" class="form-control poll-option" onkeydown="handleInput(event)" data-option-id="2" placeholder="Enter poll option" aria-label="Poll option" />\n      <span class="input-group-text poll-image" data-option-id="2" data-image-url="" style="display: none"> </span>\n      <button type="button" class="remove-image btn btn-warning" onclick="deleteImage(event)" data-option-id="2" style="display: none">\n        <i data-option-id="2" class="material-icons notranslate">hide_image</i>\n      </button>\n      <button type="button" class="remove-input btn btn-danger" onclick="deleteInput(event)" data-option-id="2">\n        <i class="material-icons notranslate" data-option-id="2">delete_forever</i>\n      </button>\n    </div>\n  </div>\n</div>',changeSiteLinkTarget("_self")}function noDuplicates(){let e=[...document.querySelectorAll(".poll-option")].map((e=>e.value));return e.length===new Set(e).size}function checkEmpty(){let e=[...document.querySelectorAll(".poll-option")].map((e=>e.value)),t=[...new Set(e)];return!t[0]&&1==t.length}function removeDuplicates(e=!1){let t=[...document.querySelectorAll(".poll-option")],l=[...document.querySelectorAll(".remove-input")],n=[];for(let o=0;o<t.length;o++)n.includes(t[o].value)||e&&!t[o].value.replace(/\s+/g,"")?l[o].click():n.push(t[o].value)}function updateTimer(e){e.value>0?elements.results_timer.disabled=!1:(elements.results_timer.checked&&(elements.results_anyone.checked=!0),elements.results_timer.disabled=!0)}function copyLink(e){navigator.clipboard.writeText(e),copyTooltip.show(),setTimeout((()=>{copyTooltip.hide()}),1e3)}async function addOptionBulk(){resetPollModal();let e=elements.bulkOptions.value.split(/\r?\n/),t=[];for(let l=0;l<e.length;l++)!t.includes(e[l])&&e[l].replace(/\s+/g,"")&&t.push(e[l].trim());elements.bulkOptions.value="";for(let e=0,l=t.length;e<l;e++)addInput();let l=[...document.querySelectorAll(".poll-image")],n=[...document.querySelectorAll(".poll-option")],o=[...document.querySelectorAll(".remove-image")];for(let e=0,a=n.length;e<a;e++){let a=t[0];if(a&&!n[e].value&&(t.shift(),n[e].value=a,a.startsWith("http"))){let t={method:"GET",headers:{},redirect:"follow"};try{(await fetch(`https://helper.donk.workers.dev/cors/?${a.split(" ")[0]}`,t)).headers.get("Content-Type").startsWith("image")&&(l[e].innerHTML=`<div class="resizable"><img src="${a.split(" ")[0]}"></div>`,l[e].dataset.imageUrl=a.split(" ")[0],l[e].style.display="block",o[e].style.display="block",n[e].value=a.split(" ").slice(1).join(""))}catch(e){console.log(e)}}}removeDuplicates(!0)}function resetPollModal(){elements.errorDiv.innerHTML="",elements.pollLinkDiv.innerHTML='<p class="placeholder-glow">\n  <span class="placeholder placeholder-lg col-12 bg-warning"></span>\n  </p>',elements.pollTitleDiv.innerHTML='<p class="placeholder-glow">\n  <span class="placeholder col-12"></span>\n  </p>',elements.pollOptionsDiv.innerHTML='<p class="placeholder-glow">\n  <span class="placeholder col-12"></span>\n  </p>',elements.pollSettingsDiv.innerHTML='<p class="placeholder-glow">\n  <span class="placeholder col-12"></span>\n  </p>'}function checkSize(){let e=elements.pollTitle.value?elements.pollTitle.value:"Untitled poll",t=[...document.querySelectorAll(".poll-image")],l=[...document.querySelectorAll(".poll-option")],n=[],o=[],a=[],i=[];for(let e=0,s=l.length;e<s;e++)(l[e].value||t[e].dataset.imageUrl)&&(!l[e].value&&t[e].dataset.imageUrl?n.push(`Option #${e+1} with image`):n.push(l[e].value),o.push(t[e].dataset.imageUrl),a[e]=1e9,i[e]=[255,255,255]);let s={title:e,options:l,images:o,scores:a,votes:1e9,colors:i,mode:1,endtime:1678513462683,multianswer:!1,creatorip:"123.456.789.123"};return(new TextEncoder).encode(JSON.stringify(s)).length/1024>100}async function createPoll(){if(checkEmpty())return void showToast("No poll options added","warning",3e3);if(noDuplicates()||removeDuplicates(),checkSize())return void showToast("Too many poll options","danger",3e3);let e,t=elements.multipleAnswersAllowed.checked;switch(elements.pollTimerUnit.value){case"m":e=Math.ceil(60*parseFloat(elements.pollTimerValue.value))||0;break;case"h":e=Math.ceil(3600*parseFloat(elements.pollTimerValue.value))||0;break;case"d":e=Math.ceil(86400*parseFloat(elements.pollTimerValue.value))||0;break;default:e=0}let l=elements.pollTitle.value?elements.pollTitle.value:"Untitled poll",n=[...document.querySelectorAll(".poll-image")],o=[...document.querySelectorAll(".poll-option")],a=[],i=[];for(let e=0,t=o.length;e<t;e++)(o[e].value||n[e].dataset.imageUrl)&&(!o[e].value&&n[e].dataset.imageUrl?a.push(`Option #${e+1} with image`):a.push(o[e].value),i.push(n[e].dataset.imageUrl));if(a.length<2)showToast("You can't create a poll with less than 2 options","warning",3e3);else{resetPollModal(),pollModal.show();try{if(token=await grecaptcha.execute(ckey,{action:"submit"}),!token)return void captchaModal.show();let n={method:"POST",headers:{},redirect:"follow","Content-Type":"application/json",body:JSON.stringify({captchatoken:token,title:l,options:a,images:i,mode:mode,level:level,endtime:e,multianswer:t})},o=await fetch("https://polls.donk.workers.dev/createpoll",n),s=await o.json();if(200!=o.status)return void(elements.errorDiv.innerHTML=`Failed to create poll.<br>Error: ${s.message}`);window.open(`https://poll.chat.vote/${s.data.id}`,"_blank").focus(),elements.pollLinkDiv.innerHTML=`\n    <div class="input-group mb-3">\n      <input type="text" class="form-control" id="pollLink" onclick="copyLink('https://poll.chat.vote/${s.data.id}')" value="https://poll.chat.vote/${s.data.id}" />\n      <button\n        type="button"\n        id="copyLinkButton"\n        class="btn btn-outline-secondary"\n        data-bs-toggle="tooltip"\n        data-bs-delay="200"\n        data-bs-trigger="manual"\n        data-bs-placement="bottom"\n        data-bs-title="Link copied :)"\n        onclick="copyLink('https://poll.chat.vote/${s.data.id}')">\n        <i class="material-icons notranslate">content_copy</i>\n      </button>\n    </div>\n    `,copyTooltip=new bootstrap.Tooltip(document.getElementById("copyLinkButton"),{trigger:"hover"}),elements.pollTitleDiv.innerHTML=`\n    <ul class="list-unstyled">\n      <li>\n      <ul>\n        <li>${s.data.title}</li>\n      </ul>\n      </li>\n    </ul>`;let r='\n            <ul class="list-unstyled">\n            <li>\n            <ul>';for(let e=0,t=s.data.options.length;e<t;e++)r+=`<li>${s.data.options[e]}</li>`;r+="\n            </ul>\n            </li>\n            </ul>",elements.pollOptionsDiv.innerHTML=r;let d="";switch(s.data.mode){case 0:d="Results visible to anyone";break;case 1:d="Results visible voters only";break;case 2:d=`Results will be revealed in ${Math.ceil((parseInt(s.data.endtime,10)-Date.now()/1e3)/60)} minutes`;break;case 3:d="Results visible to you only";break}let c="";switch(s.data.level){case 0:c="<li>Duplicate detection level: low</li>";break;case 1:c="<li>Duplicate detection level: high</li>";break}let p="No time limit";s.data.endtime&&(p=`Poll will close in ${Math.ceil((parseInt(s.data.endtime,10)-Date.now()/1e3)/60)} minutes`),elements.pollSettingsDiv.innerHTML=`\n      <ul class="list-unstyled">\n        <li>\n        <ul>\n          <li>${d}</li>\n          <li>${s.data.multianswer?"Multiple answers allowed":"Multiple answers not allowed"}</li>\n          <li>${p}</li>\n          ${c}\n        </ul>\n        </li>\n      </ul>`}catch(e){elements.errorDiv.innerHTML=`Failed to create poll.<br>Error: ${e}`}}}async function handleInput(e){let t=parseInt(e.target.dataset.optionId,10);if("Tab"===e.key&&e.preventDefault(),("ArrowUp"===e.key||"Tab"===e.key&&e.shiftKey)&&selectPreviousInput(t),("Enter"===e.key||"ArrowDown"===e.key||"Tab"===e.key&&!e.shiftKey)&&(selectNextInput(t),e.target.value.startsWith("http"))){let l=e.target.value,n={method:"GET",headers:{},redirect:"follow"};try{if((await fetch(`https://helper.donk.workers.dev/cors/?${l.split(" ")[0]}`,n)).headers.get("Content-Type").startsWith("image")){let e=[...document.querySelectorAll(".poll-image")],n=[...document.querySelectorAll(".poll-option")],o=[...document.querySelectorAll(".remove-image")],a=e.findIndex((e=>parseInt(e.dataset.optionId,10)===t));-1!=a&&(e[a].innerHTML=`<div class="resizable"><img src="${l.split(" ")[0]}"></div>`,e[a].dataset.imageUrl=l.split(" ")[0],e[a].style.display="block",o[a].style.display="block",n[a].value=l.split(" ").slice(1).join(""))}}catch(e){console.log(e)}}let l=[...document.querySelectorAll(".poll-option")];e.target.dataset.optionId==l[l.length-1].dataset.optionId&&e.target.value&&addInput(!1)}function selectPreviousInput(e){let t=[...document.querySelectorAll(".poll-option")],l=t.findIndex((t=>parseInt(t.dataset.optionId,10)===e));0==l?(elements.pollTitle.focus(),elements.pollTitle.select()):-1!=l&&(t[l-1].focus(),t[l-1].select())}function selectNextInput(e){let t=[...document.querySelectorAll(".poll-option")],l=t.findIndex((t=>parseInt(t.dataset.optionId,10)===e));l+1==t.length?addInput():-1!=l&&(t[l+1].focus(),t[l+1].select())}function addInput(e=!0){elements.optionsDiv.insertAdjacentHTML("beforeend",`<div class="card bg-body-tertiary option-card" data-option-id="${++numberOfOptions}">\n    <div class="card-body">\n      <div class="input-group">\n        <input type="text" class="form-control poll-option" onkeydown="handleInput(event)" data-option-id="${numberOfOptions}" placeholder="Enter poll option" aria-label="Poll option" />\n        <span class="input-group-text poll-image" data-option-id="${numberOfOptions}" data-image-url="" style="display: none"> </span>\n        <button type="button" class="remove-image btn btn-warning" onclick="deleteImage(event)" data-option-id="${numberOfOptions}" style="display: none">\n          <i data-option-id="${numberOfOptions}" class="material-icons notranslate">hide_image</i>\n        </button>\n        <button type="button" class="remove-input btn btn-danger" onclick="deleteInput(event)" data-option-id="${numberOfOptions}">\n          <i class="material-icons notranslate" data-option-id="${numberOfOptions}">delete_forever</i>\n        </button>\n      </div>\n    </div>\n  </div>`),e&&selectNextInput(numberOfOptions-1),changeSiteLinkTarget("_blank")}function deleteInput(e){let t=[...document.querySelectorAll(".option-card")],l=t.findIndex((t=>parseInt(t.dataset.optionId,10)===parseInt(e.target.dataset.optionId,10)));-1!=l&&(t.length>2?t[l].remove():showToast("You can't have less than 2 options","danger",3e3))}function deleteImage(e){let t=[...document.querySelectorAll(".poll-image")],l=[...document.querySelectorAll(".remove-image")],n=t.findIndex((t=>parseInt(t.dataset.optionId,10)===parseInt(e.target.dataset.optionId,10)));-1!=n&&(t[n].innerHTML="",t[n].dataset.imageUrl="",t[n].style.display="none",l[n].style.display="none")}function switchTheme(e){document.documentElement.setAttribute("data-bs-theme",e?"dark":"light"),document.getElementById("twitchLogo").style.filter=`invert(${e?.25:.65})`}window.onload=function(){let e=new URL(window.location.href).searchParams.get("p");e?window.location.href=`https://poll.chat.vote/${e}`:(darkTheme="true"===(localStorage.getItem("darkTheme")||"true"),elements.darkTheme.checked=darkTheme??!0,switchTheme(elements.darkTheme.checked),load_localStorage(),refreshData(),deleteAllModal=new bootstrap.Modal(elements.deleteAllModal),pollModal=new bootstrap.Modal(elements.pollModal),captchaModal=new bootstrap.Modal(elements.captchaModal),enableTooltips(),enablePopovers(),elements.pollTitle.addEventListener("keydown",(function(e){if("Tab"===e.key&&e.preventDefault(),"Enter"===e.key||"ArrowDown"===e.key||"Tab"===e.key){let e=[...document.querySelectorAll(".poll-option")];e[0].focus(),e[0].select()}})),elements.darkTheme.onchange=function(){switchTheme(this.checked),saveSettings()},elements.results_anyone.onchange=function(){this.checked&&(mode=0),saveSettings()},elements.results_voters.onchange=function(){this.checked&&(mode=1),saveSettings()},elements.results_timer.onchange=function(){this.checked&&(mode=2),saveSettings()},elements.results_creator.onchange=function(){this.checked&&(mode=3),saveSettings()},elements.pollTimerValue.onchange=function(){updateTimer(this),saveSettings()},elements.multipleAnswersAllowed.onchange=function(){this.checked&&(multipleAnswersAllowed=!0),saveSettings()},elements.detect_low.onchange=function(){this.checked&&(level=0),saveSettings()},elements.detect_high.onchange=function(){this.checked&&(level=1),saveSettings()},elements.pollTitle.focus(),elements.pollTitle.select())};